      // ==================== 기타 함수들 ====================<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>응급실 게시판 시스템</title>

    <!-- 부트스트랩 CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- 아이콘 -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- 구글 폰트 -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #007aff;
        --primary-light: #5ac8fa;
        --primary-dark: #0051d5;
        --secondary: #f2f2f7;
        --success: #34c759;
        --warning: #ff9500;
        --danger: #ff3b30;
        --info: #007aff;
        --dark: #1c1c1e;
        --light: #ffffff;
        --gray-100: #f5f5f7;
        --gray-200: #e5e5ea;
        --gray-300: #d1d1d6;
        --gray-400: #8e8e93;
        --gray-500: #636366;
        --gray-600: #48484a;
        --gray-700: #3a3a3c;
        --gray-800: #2c2c2e;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.08);
        --border-radius: 20px;
        --border-radius-sm: 12px;
        --border-radius-xs: 8px;
      }

      body {
        background: linear-gradient(
          135deg,
          #f5f5f7 0%,
          #fafafa 25%,
          #ffffff 50%,
          #f2f2f7 75%,
          #e5e5ea 100%
        );
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          "Helvetica Neue", "Inter", sans-serif;
        color: var(--dark);
        line-height: 1.47;
        min-height: 100vh;
        font-weight: 400;
      }

      .er-header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.04);
        color: var(--dark);
        padding: 4rem 0;
        margin-bottom: 2.5rem;
        position: relative;
        overflow: hidden;
      }

      .er-header h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-light) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
      }

      .status-online {
        background: var(--success);
        color: white;
      }
      .status-offline {
        background: var(--danger);
        color: white;
      }
      .status-loading {
        background: var(--warning);
        color: white;
      }

      .er-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: saturate(180%) blur(20px);
        border: 0.5px solid rgba(0, 0, 0, 0.04);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .er-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .er-card-header {
        background: rgba(255, 255, 255, 0.9);
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.04);
        padding: 1.5rem 2rem;
        font-weight: 600;
        font-size: 1.125rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notice-item {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
      }

      .notice-item:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      .notice-department {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-light) 100%
        );
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 1rem;
      }

      .notice-content {
        flex: 1;
        color: var(--dark);
        line-height: 1.4;
        font-size: 0.9rem;
      }

      .notice-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
      }

      .notice-date {
        color: var(--gray-500);
        font-size: 0.7rem;
        white-space: nowrap;
      }

      .er-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--border-radius-xs);
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        text-decoration: none;
      }

      .er-btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .er-btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        color: white;
      }

      .er-btn-success {
        background: var(--success);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .er-btn-success:hover {
        background: #30d158;
        transform: translateY(-1px);
        color: white;
      }

      .er-btn-outline {
        background: rgba(0, 122, 255, 0.08);
        border: 1px solid rgba(0, 122, 255, 0.15);
        color: var(--primary);
      }

      .er-btn-outline:hover {
        background: rgba(0, 122, 255, 0.12);
        color: var(--primary-dark);
      }

      .er-btn-outline.active {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .btn-group .er-btn:first-child {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
      }

      .btn-group .er-btn:not(:first-child):not(:last-child) {
        border-radius: 0;
        border-left: none;
      }

      .btn-group .er-btn:last-child {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-left: none;
      }

      .er-btn-danger-small {
        background: transparent;
        color: var(--danger);
        border: none;
        padding: 0.3rem;
        font-size: 0.8rem;
        border-radius: 4px;
        opacity: 0.7;
      }

      .er-btn-danger-small:hover {
        background: var(--danger);
        color: white;
        opacity: 1;
      }

      .er-form-control {
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        width: 100%;
        margin-bottom: 1rem;
      }

      .er-form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        outline: none;
        background: rgba(255, 255, 255, 1);
      }

      .er-form-label {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.9rem;
      }

      .er-alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: none;
        box-shadow: var(--shadow-md);
      }

      .er-alert-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border-left: 4px solid var(--success);
      }

      .er-alert-error {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        border-left: 4px solid var(--danger);
      }

      .er-alert-info {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        border-left: 4px solid var(--info);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--gray-600);
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      @media (max-width: 768px) {
        .er-header h1 {
          font-size: 2rem;
        }
        .connection-status {
          position: static;
          margin-bottom: 1rem;
          text-align: center;
        }
        .notice-item {
          flex-direction: column;
          gap: 1rem;
        }
        .notice-actions {
          align-items: flex-start;
        }
        
        /* 모바일에서 버튼 그룹 세로 배치 */
        .er-card-header > div {
          flex-direction: column;
          gap: 0.5rem;
          align-items: stretch;
        }
        
        .btn-group {
          width: 100%;
        }
        
        .btn-group .er-btn {
          flex: 1;
          justify-content: center;
        }
        
        /* 과별 필터 버튼 모바일 최적화 */
        #departmentFilter .d-flex {
          justify-content: flex-start !important;
        }
        
        #departmentFilter .er-btn {
          font-size: 0.8rem;
          padding: 0.4rem 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- 연결 상태 표시 -->
    <div id="connectionStatus" class="connection-status status-loading">
      <i class="fas fa-circle"></i> 시스템 초기화 중...
    </div>

    <!-- 페이지 헤더 -->
    <div class="er-header">
      <div class="container">
        <div class="row">
          <div class="col-12 text-center">
            <h1><i class="fas fa-hospital"></i> 응급실 게시판</h1>
            <p class="lead">Emergency Department Notice Board System</p>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- 오늘의 공지사항 -->
      <div class="er-card">
        <div class="er-card-header">
          <span><i class="fas fa-list-alt"></i> 오늘의 공지사항</span>
          <div>
            <div class="btn-group" role="group">
              <button
                class="er-btn er-btn-success"
                onclick="refreshNotices()"
                id="refreshBtn"
              >
                <i class="fas fa-sync-alt"></i> 새로고침
              </button>
              <button 
                class="er-btn er-btn-outline"
                onclick="showAllNotices()"
                id="allNoticesBtn"
              >
                <i class="fas fa-list"></i> 전체 공지사항
              </button>
              <button 
                class="er-btn er-btn-outline"
                onclick="showHistoryNotices()"
                id="historyBtn"
              >
                <i class="fas fa-history"></i> History
              </button>
            </div>
            
            <!-- 백업/불러오기 버튼 -->
            <div class="btn-group ms-2" role="group">
              <button 
                class="er-btn er-btn-outline"
                onclick="backupNotices()"
                id="backupBtn"
                title="공지사항을 JSON 파일로 백업"
              >
                <i class="fas fa-download"></i> 백업
              </button>
              <button 
                class="er-btn er-btn-outline"
                onclick="triggerFileInput()"
                id="restoreBtn"
                title="백업 파일에서 공지사항 복원"
              >
                <i class="fas fa-upload"></i> 불러오기
              </button>
            </div>
            
            <!-- 숨겨진 파일 입력 -->
            <input 
              type="file" 
              id="fileInput" 
              accept=".json" 
              style="display: none;" 
              onchange="restoreNotices(event)"
            />
          </div>
        </div>
        <div class="card-body p-4">
          <!-- 과별 정렬 버튼 -->
          <div id="departmentFilter" class="mb-3" style="display: none;">
            <div class="d-flex flex-wrap gap-2 justify-content-center">
              <button class="er-btn er-btn-outline" onclick="filterByDepartment('all')" id="filter-all">
                <i class="fas fa-list"></i> 전체
              </button>
              <button class="er-btn er-btn-outline" onclick="filterByDepartment('GI')" id="filter-GI">
                <i class="fas fa-stomach"></i> GI
              </button>
              <button class="er-btn er-btn-outline" onclick="filterByDepartment('CV')" id="filter-CV">
                <i class="fas fa-heartbeat"></i> CV
              </button>
              <button class="er-btn er-btn-outline" onclick="filterByDepartment('Biliary')" id="filter-Biliary">
                <i class="fas fa-liver"></i> Biliary
              </button>
              <button class="er-btn er-btn-outline" onclick="filterByDepartment('DR')" id="filter-DR">
                <i class="fas fa-x-ray"></i> DR
              </button>
              <button class="er-btn er-btn-outline" onclick="filterByDepartment('NS')" id="filter-NS">
                <i class="fas fa-brain"></i> NS
              </button>
              <button class="er-btn er-btn-outline" onclick="filterByDepartment('GS')" id="filter-GS">
                <i class="fas fa-cut"></i> GS
              </button>
              <button class="er-btn er-btn-outline" onclick="filterByDepartment('PLM')" id="filter-PLM">
                <i class="fas fa-lungs"></i> PLM
              </button>
            </div>
          </div>
          
          <div id="noticesList">
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <h5>공지사항을 불러오는 중...</h5>
              <p>시스템을 초기화하고 있습니다.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 공지사항 입력 폼 -->
      <div class="er-card">
        <div class="er-card-header">
          <i class="fas fa-plus-circle"></i> 새 공지사항 등록
        </div>
        <div class="card-body p-4">
          <!-- 메시지 영역 -->
          <div id="successMessage" class="er-alert er-alert-success">
            <i class="fas fa-check-circle"></i>
            <span id="successText">공지사항이 성공적으로 등록되었습니다!</span>
          </div>
          <div id="errorMessage" class="er-alert er-alert-error">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">오류가 발생했습니다.</span>
          </div>
          <div id="infoMessage" class="er-alert er-alert-info">
            <i class="fas fa-info-circle"></i>
            <span id="infoText">시스템 정보입니다.</span>
          </div>

          <form id="noticeForm">
            <div class="row">
              <div class="col-md-4">
                <label class="er-form-label"
                  >진료과 <span style="color: var(--danger)">*</span></label
                >
                <select class="er-form-control" id="department" required>
                  <option value="">선택하세요</option>
                  <option value="GI">GI</option>
                  <option value="CV">CV</option>
                  <option value="Biliary">Biliary</option>
                  <option value="DR">DR</option>
                  <option value="NS">NS</option>
                  <option value="GS">GS</option>
                  <option value="PLM">PLM</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="er-form-label"
                  >시작 날짜 <span style="color: var(--danger)">*</span></label
                >
                <input
                  type="date"
                  class="er-form-control"
                  id="startDate"
                  required
                />
              </div>
              <div class="col-md-4">
                <label class="er-form-label">종료 날짜 (선택)</label>
                <input type="date" class="er-form-control" id="endDate" />
              </div>
            </div>

            <label class="er-form-label"
              >공지 내용 <span style="color: var(--danger)">*</span></label
            >
            <textarea
              class="er-form-control"
              id="content"
              placeholder="공지사항 내용을 입력하세요..."
              required
              rows="4"
            ></textarea>

            <label class="er-form-label">작성자</label>
            <input
              type="text"
              class="er-form-control"
              id="author"
              placeholder="작성자명 (선택)"
            />

            <div class="d-flex gap-2 justify-content-end">
              <button
                type="button"
                class="er-btn er-btn-outline"
                onclick="clearForm()"
              >
                <i class="fas fa-redo"></i> 초기화
              </button>
              <button
                type="submit"
                class="er-btn er-btn-primary"
                id="submitBtn"
              >
                <i class="fas fa-save"></i> 등록
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
      // ==================== 설정 ====================
      // 🔧 수정 구역 - Google Apps Script URL 업데이트됨
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4pyEdWFBffkL_34JymjJSBME844JFy7FOukH-oXgEkJZOJbCjz59CMA_TcZ6RENK_/exec";
      const AUTO_REFRESH_INTERVAL = 30000; // 30초

      let notices = [];
      let isOnline = false;
      let currentViewMode = 'today'; // 'today', 'all', 'history'
      let currentFilter = 'all'; // 현재 과별 필터
      let autoRefreshTimer = null;

      // ==================== 초기화 ====================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("🏥 응급실 게시판 시스템 시작");
        initializeSystem();
      });

      function initializeSystem() {
        initializeDates();
        setupFormEventListeners();
        
        // 기본 보기 모드 설정
        currentViewMode = 'today';
        currentFilter = 'all';
        updateViewButtons();

        console.log("🔗 Google Apps Script URL:", GOOGLE_SCRIPT_URL);
        loadNoticesFromGoogle();

        if (AUTO_REFRESH_INTERVAL > 0) {
          startAutoRefresh();
        }
      }

      // ==================== 구글 시트 통신 (향상된 오류 처리) ====================
      async function loadNoticesFromGoogle() {
        showConnectionStatus("loading", "데이터 로드 중...");

        try {
          console.log("🔄 Google Sheets 연결 시도");

          const formData = new URLSearchParams();
          formData.append("method", "GET");
          formData.append("timestamp", Date.now().toString());

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(
              `HTTP 오류 ${response.status}: ${response.statusText}`
            );
          }

          let data;
          try {
            const responseText = await response.text();
            console.log("📄 응답 텍스트:", responseText.substring(0, 200) + "...");
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error("JSON 파싱 오류:", parseError);
            throw new Error("서버 응답을 처리할 수 없습니다. Google Apps Script 설정을 확인해주세요.");
          }

          console.log("📊 받은 데이터:", data);

          if (data.error) {
            if (data.error.includes("openById")) {
              throw new Error("Google Sheets 접근 권한 또는 시트 ID를 확인해주세요.");
            }
            throw new Error(`서버 오류: ${data.error}`);
          }

          notices = data.notices || [];
          isOnline = true;
          showConnectionStatus("online", `연결됨 - ${notices.length}개 공지사항`);
          displayNotices();

          console.log(`✅ ${notices.length}개 공지사항 로드 완료`);
        } catch (error) {
          console.error("❌ 연결 오류:", error);
          isOnline = false;

          let errorMessage = "연결 실패";
          if (error.name === "AbortError") {
            errorMessage = "연결 시간 초과";
          } else if (error.message.includes("openById")) {
            errorMessage = "시트 권한 오류";
          } else if (error.message.includes("Failed to fetch")) {
            errorMessage = "네트워크 오류";
          }

          showConnectionStatus("offline", errorMessage);
          showMessage("error", `연결 실패: ${error.message}. Google Apps Script 설정을 확인해주세요.`);
          loadLocalBackup();
        }
      }

      async function addNoticeToGoogle(noticeData) {
        try {
          showConnectionStatus("loading", "저장 중...");

          const formData = new URLSearchParams();
          formData.append("method", "POST");
          formData.append("department", noticeData.department);
          formData.append("startDate", noticeData.startDate);
          formData.append("endDate", noticeData.endDate || "");
          formData.append("content", noticeData.content);
          formData.append("author", noticeData.author || "");

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP 오류 ${response.status}: ${response.statusText}`);
          }

          let result;
          try {
            const responseText = await response.text();
            result = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error("서버 응답을 처리할 수 없습니다.");
          }

          if (result.error) {
            if (result.error.includes("openById")) {
              throw new Error("Google Sheets 접근 권한을 확인해주세요.");
            }
            throw new Error(result.error);
          }

          showMessage("success", "공지사항이 성공적으로 등록되었습니다!");

          setTimeout(() => {
            loadNoticesFromGoogle();
          }, 1000);

          clearForm();
          return true;
        } catch (error) {
          console.error("❌ 저장 오류:", error);
          showMessage("error", `저장 실패: ${error.message}`);

          if (error.message.includes("Failed to fetch") || error.message.includes("시간 초과")) {
            showMessage("info", "네트워크 문제로 인해 저장에 실패했습니다.");
          }

          return false;
        }
      }

      async function deleteNoticeFromGoogle(id) {
        try {
          const formData = new URLSearchParams();
          formData.append("method", "DELETE");
          formData.append("id", id);

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          showMessage("success", "공지사항이 삭제되었습니다.");
          loadNoticesFromGoogle();
          return true;
        } catch (error) {
          console.error("❌ 삭제 오류:", error);
          showMessage("error", "삭제 실패: " + error.message);
          return false;
        }
      }

      // ==================== 보기 모드 관리 ====================
      function showAllNotices() {
        currentViewMode = 'all';
        updateViewButtons();
        displayNotices();
        console.log("📋 전체 공지사항 보기 모드");
      }

      function showHistoryNotices() {
        currentViewMode = 'history';
        updateViewButtons();
        displayNotices();
        console.log("📜 히스토리 보기 모드");
      }

      function showTodayNotices() {
        currentViewMode = 'today';
        updateViewButtons();
        displayNotices();
        console.log("📅 오늘 공지사항 보기 모드");
      }

      function updateViewButtons() {
        // 버튼 활성화 상태 초기화
        document.getElementById('refreshBtn').classList.remove('active');
        document.getElementById('allNoticesBtn').classList.remove('active');
        document.getElementById('historyBtn').classList.remove('active');
        
        // 현재 모드에 따라 버튼 활성화
        if (currentViewMode === 'today') {
          document.getElementById('refreshBtn').classList.add('active');
        } else if (currentViewMode === 'all') {
          document.getElementById('allNoticesBtn').classList.add('active');
        } else if (currentViewMode === 'history') {
          document.getElementById('historyBtn').classList.add('active');
        }
        
        // 과별 필터 버튼 표시/숨김
        const filterDiv = document.getElementById('departmentFilter');
        if (currentViewMode !== 'today') {
          filterDiv.style.display = 'block';
        } else {
          filterDiv.style.display = 'none';
        }
        
        // 헤더 제목 업데이트
        updateHeaderTitle();
      }

      function updateHeaderTitle() {
        const headerSpan = document.querySelector('.er-card-header span');
        if (currentViewMode === 'today') {
          headerSpan.innerHTML = '<i class="fas fa-list-alt"></i> 오늘의 공지사항';
        } else if (currentViewMode === 'all') {
          headerSpan.innerHTML = '<i class="fas fa-list"></i> 전체 공지사항';
        } else if (currentViewMode === 'history') {
          headerSpan.innerHTML = '<i class="fas fa-history"></i> 히스토리';
        }
      }

      // ==================== 과별 필터링 ====================
      function filterByDepartment(department) {
        currentFilter = department;
        
        // 모든 필터 버튼 비활성화
        document.querySelectorAll('[id^="filter-"]').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // 선택된 필터 버튼 활성화
        document.getElementById(`filter-${department}`).classList.add('active');
        
        displayNotices();
        console.log(`🏥 과별 필터 적용: ${department}`);
      }

      // ==================== UI 함수들 ====================
      function showConnectionStatus(status, message) {
        const statusDiv = document.getElementById("connectionStatus");
        statusDiv.className = `connection-status status-${status}`;

        const icons = {
          online: "fas fa-check-circle",
          offline: "fas fa-exclamation-circle",
          loading: "fas fa-spinner fa-spin"
        };

        statusDiv.innerHTML = `<i class="${icons[status]}"></i> ${message}`;
      }

      function showMessage(type, message) {
        const successDiv = document.getElementById("successMessage");
        const errorDiv = document.getElementById("errorMessage");
        const infoDiv = document.getElementById("infoMessage");

        successDiv.style.display = "none";
        errorDiv.style.display = "none";
        infoDiv.style.display = "none";

        if (type === "success") {
          document.getElementById("successText").textContent = message;
          successDiv.style.display = "block";
          setTimeout(() => (successDiv.style.display = "none"), 5000);
        } else if (type === "error") {
          document.getElementById("errorText").textContent = message;
          errorDiv.style.display = "block";
          setTimeout(() => (errorDiv.style.display = "none"), 8000);
        } else if (type === "info") {
          document.getElementById("infoText").textContent = message;
          infoDiv.style.display = "block";
          setTimeout(() => (infoDiv.style.display = "none"), 10000);
        }
      }

      function displayNotices() {
        const container = document.getElementById("noticesList");
        let filteredNotices = [];

        // 모드에 따라 공지사항 필터링
        if (currentViewMode === 'today') {
          filteredNotices = getTodayNotices();
        } else if (currentViewMode === 'all') {
          filteredNotices = getAllNotices();
        } else if (currentViewMode === 'history') {
          filteredNotices = getHistoryNotices();
        }

        // 과별 필터 적용
        if (currentFilter !== 'all') {
          filteredNotices = filteredNotices.filter(notice => 
            notice.department === currentFilter
          );
        }

        if (filteredNotices.length === 0) {
          let emptyMessage = "";
          if (currentViewMode === 'today') {
            emptyMessage = "오늘 표시할 공지사항이 없습니다";
          } else if (currentViewMode === 'all') {
            emptyMessage = "전체 공지사항이 없습니다";
          } else if (currentViewMode === 'history') {
            emptyMessage = "히스토리에 표시할 공지사항이 없습니다";
          }
          
          if (currentFilter !== 'all') {
            emptyMessage += ` (${currentFilter} 과)`;
          }

          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <h5>${emptyMessage}</h5>
              <p>새로운 공지사항을 등록해주세요.</p>
            </div>
          `;
          return;
        }

        let html = "";
        filteredNotices.forEach((notice) => {
          html += createNoticeHTML(notice);
        });

        container.innerHTML = html;
        saveLocalBackup();
      }

      function createNoticeHTML(notice) {
        const departmentColors = {
          GI: "#10b981",
          CV: "#ef4444",
          Biliary: "#f59e0b",
          DR: "#6366f1",
          NS: "#8b5cf6",
          GS: "#06b6d4",
          PLM: "#84cc16",
        };

        const departmentIcons = {
          GI: "fas fa-stomach",
          CV: "fas fa-heartbeat",
          Biliary: "fas fa-liver",
          DR: "fas fa-x-ray",
          NS: "fas fa-brain",
          GS: "fas fa-cut",
          PLM: "fas fa-lungs",
        };

        const bgColor = departmentColors[notice.department] || "#4f46e5";
        const icon = departmentIcons[notice.department] || "fas fa-hospital";

        const startDate = new Date(notice.startDate).toLocaleDateString("ko-KR", { month: "short", day: "numeric" });
        const endDateText = notice.endDate ? ` ~ ${new Date(notice.endDate).toLocaleDateString("ko-KR", { month: "short", day: "numeric" })}` : " (무기한)";

        return `
          <div class="notice-item" data-id="${notice.id}">
            <div>
              <span class="notice-department" style="background: ${bgColor}">
                <i class="${icon}"></i> ${notice.department}
              </span>
              <div class="notice-content">${notice.content.replace(/\n/g, "<br>")}</div>
            </div>
            <div class="notice-actions">
              <span class="notice-date">${startDate}${endDateText}</span>
              ${notice.author ? `<small style="color: var(--gray-500)">${notice.author}</small>` : ""}
              <button class="er-btn-danger-small" onclick="deleteNotice('${notice.id}')" title="삭제">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }

      function getTodayNotices() {
        const today = new Date().toISOString().split("T")[0];
        return notices
          .filter((notice) => {
            return notice.endDate
              ? today >= notice.startDate && today <= notice.endDate
              : today >= notice.startDate;
          })
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }

      function getAllNotices() {
        const today = new Date().toISOString().split("T")[0];
        return notices
          .filter((notice) => {
            // 오늘 이후에 시작하거나, 아직 끝나지 않은 공지사항
            return notice.endDate
              ? today <= notice.endDate  // 종료일이 오늘 이후
              : today <= notice.startDate || today >= notice.startDate; // 시작일이 오늘 이후이거나 이미 시작됨
          })
          .sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); // 시작일 순으로 정렬
      }

      function getHistoryNotices() {
        const today = new Date().toISOString().split("T")[0];
        return notices
          .filter((notice) => {
            // 종료일이 있고 오늘 이전에 끝난 공지사항
            return notice.endDate && today > notice.endDate;
          })
          .sort((a, b) => new Date(b.endDate) - new Date(a.endDate)); // 종료일 역순으로 정렬
      }

      // ==================== 폼 관리 ====================
      function initializeDates() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("startDate").value = today;
      }

      function setupFormEventListeners() {
        document.getElementById("noticeForm").addEventListener("submit", async function (e) {
          e.preventDefault();
          await addNotice();
        });
      }

      async function addNotice() {
        const formData = {
          department: document.getElementById("department").value,
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value || "",
          content: document.getElementById("content").value.trim(),
          author: document.getElementById("author").value.trim(),
        };

        if (!formData.department || !formData.startDate || !formData.content) {
          showMessage("error", "필수 항목을 모두 입력해주세요.");
          return;
        }

        console.log("📝 새 공지사항 등록:", formData);
        await addNoticeToGoogle(formData);
      }

      function clearForm() {
        document.getElementById("noticeForm").reset();
        initializeDates();
      }

      async function deleteNotice(id) {
        if (confirm("이 공지사항을 삭제하시겠습니까?")) {
          await deleteNoticeFromGoogle(id);
        }
      }

      // ==================== 백업/불러오기 기능 ====================
      
      // 🔧 수정 가능 구역 - 백업 파일명 설정
      function generateBackupFileName() {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
        return `응급실공지사항_백업_${dateStr}_${timeStr}.json`;
      }

      /**
       * 전체 공지사항을 JSON 파일로 백업
       */
      function backupNotices() {
        try {
          if (!notices || notices.length === 0) {
            showMessage("info", "백업할 공지사항이 없습니다. 먼저 공지사항을 불러와주세요.");
            return;
          }

          // 백업 데이터 구조
          const backupData = {
            metadata: {
              version: "1.0",
              exportDate: new Date().toISOString(),
              totalNotices: notices.length,
              exportedBy: "응급실 게시판 시스템",
              description: "응급의학과 공지사항 전체 백업 파일"
            },
            notices: notices.map(notice => ({
              id: notice.id,
              department: notice.department,
              startDate: notice.startDate,
              endDate: notice.endDate || "",
              content: notice.content,
              author: notice.author || "",
              createdAt: notice.createdAt || new Date().toISOString()
            }))
          };

          // JSON 문자열 생성
          const jsonString = JSON.stringify(backupData, null, 2);
          
          // Blob 생성 및 다운로드
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = generateBackupFileName();
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          // 메모리 정리
          URL.revokeObjectURL(url);
          
          showMessage("success", `${notices.length}개 공지사항이 성공적으로 백업되었습니다!`);
          console.log(`📦 백업 완료: ${notices.length}개 공지사항`);
          
        } catch (error) {
          console.error("백업 오류:", error);
          showMessage("error", "백업 중 오류가 발생했습니다: " + error.message);
        }
      }

      /**
       * 파일 입력 창 트리거
       */
      function triggerFileInput() {
        document.getElementById('fileInput').click();
      }

      /**
       * 백업 파일에서 공지사항 복원
       */
      async function restoreNotices(event) {
        const file = event.target.files[0];
        
        if (!file) {
          return;
        }

        try {
          // 파일 유효성 검사
          if (!file.name.endsWith('.json')) {
            showMessage("error", "JSON 파일만 업로드할 수 있습니다.");
            return;
          }

          if (file.size > 10 * 1024 * 1024) { // 10MB 제한
            showMessage("error", "파일 크기가 너무 큽니다. (최대 10MB)");
            return;
          }

          showMessage("info", "백업 파일을 읽는 중...");
          
          // 파일 읽기
          const fileContent = await readFileAsText(file);
          const backupData = JSON.parse(fileContent);
          
          // 백업 파일 구조 검증
          if (!validateBackupFile(backupData)) {
            showMessage("error", "올바른 백업 파일이 아닙니다. 파일 형식을 확인해주세요.");
            return;
          }

          // 복원 확인
          const confirmMessage = `백업 파일 정보:
          
• 백업 일시: ${new Date(backupData.metadata.exportDate).toLocaleString('ko-KR')}
• 공지사항 수: ${backupData.metadata.totalNotices}개
• 버전: ${backupData.metadata.version}

현재 ${notices.length}개의 공지사항을 ${backupData.notices.length}개로 교체하시겠습니까?

⚠️ 주의: 현재 데이터는 복원 후 사라집니다!`;

          if (!confirm(confirmMessage)) {
            showMessage("info", "복원이 취소되었습니다.");
            return;
          }

          // Google Sheets에 복원 (배치 업로드)
          const success = await restoreToGoogleSheets(backupData.notices);
          
          if (success) {
            notices = backupData.notices;
            displayNotices();
            showMessage("success", `${backupData.notices.length}개 공지사항이 성공적으로 복원되었습니다!`);
            console.log(`📥 복원 완료: ${backupData.notices.length}개 공지사항`);
          } else {
            showMessage("error", "Google Sheets 복원 중 오류가 발생했습니다.");
          }

        } catch (error) {
          console.error("복원 오류:", error);
          
          if (error instanceof SyntaxError) {
            showMessage("error", "백업 파일이 손상되었거나 올바른 JSON 형식이 아닙니다.");
          } else {
            showMessage("error", "복원 중 오류가 발생했습니다: " + error.message);
          }
        } finally {
          // 파일 입력 초기화
          event.target.value = '';
        }
      }

      /**
       * 파일을 텍스트로 읽기
       */
      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = e => reject(new Error("파일을 읽을 수 없습니다."));
          reader.readAsText(file, 'utf-8');
        });
      }

      /**
       * 백업 파일 유효성 검증
       */
      function validateBackupFile(data) {
        try {
          // 필수 필드 확인
          if (!data.metadata || !data.notices) {
            return false;
          }
          
          if (!Array.isArray(data.notices)) {
            return false;
          }
          
          // 공지사항 데이터 구조 확인
          for (const notice of data.notices) {
            if (!notice.id || !notice.department || !notice.startDate || !notice.content) {
              console.warn("유효하지 않은 공지사항 데이터:", notice);
              return false;
            }
          }
          
          return true;
          
        } catch (error) {
          console.error("백업 파일 검증 오류:", error);
          return false;
        }
      }

      /**
       * Google Sheets에 배치로 데이터 복원
       */
      async function restoreToGoogleSheets(noticesData) {
        try {
          showConnectionStatus("loading", "Google Sheets에 복원 중...");
          
          const formData = new URLSearchParams();
          formData.append("method", "RESTORE");
          formData.append("notices", JSON.stringify(noticesData));
          formData.append("timestamp", Date.now().toString());

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30초 타임아웃

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP 오류 ${response.status}: ${response.statusText}`);
          }

          let result;
          try {
            const responseText = await response.text();
            result = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error("서버 응답을 처리할 수 없습니다.");
          }

          if (result.error) {
            throw new Error(result.error);
          }

          showConnectionStatus("online", `복원 완료 - ${noticesData.length}개 공지사항`);
          return true;

        } catch (error) {
          console.error("Google Sheets 복원 오류:", error);
          showConnectionStatus("offline", "복원 실패");
          
          // 로컬에만 복원하고 경고 표시
          showMessage("error", `Google Sheets 복원 실패: ${error.message}. 데이터는 로컬에만 복원되었습니다.`);
          return false;
        }
      }
      function refreshNotices() {
        currentViewMode = 'today';
        currentFilter = 'all';
        updateViewButtons();
        loadNoticesFromGoogle();
      }

      function startAutoRefresh() {
        autoRefreshTimer = setInterval(() => {
          if (isOnline && currentViewMode === 'today') {
            console.log("🔄 자동 새로고침");
            loadNoticesFromGoogle();
          }
        }, AUTO_REFRESH_INTERVAL);
      }

      function saveLocalBackup() {
        try {
          const backupData = {
            notices: notices.slice(0, 50),
            timestamp: new Date().toISOString(),
          };

          localStorage.removeItem("erNoticesBackup");
          const backupString = JSON.stringify(backupData);

          if (backupString.length > 5000000) {
            console.warn("⚠️ 백업 데이터가 너무 큽니다. 최근 20개만 저장합니다.");
            backupData.notices = notices.slice(0, 20);
          }

          localStorage.setItem("erNoticesBackup", JSON.stringify(backupData));
          console.log("💾 백업 저장 완료:", backupData.notices.length + "개 공지사항");
        } catch (error) {
          console.error("백업 저장 오류:", error);

          if (error.name === "QuotaExceededError") {
            try {
              localStorage.removeItem("erNoticesBackup");
              const minimalBackup = {
                notices: notices.slice(0, 10),
                timestamp: new Date().toISOString(),
              };
              localStorage.setItem("erNoticesBackup", JSON.stringify(minimalBackup));
              console.log("💾 최소 백업 저장 완료:", minimalBackup.notices.length + "개");
            } catch (secondError) {
              console.error("최소 백업도 실패:", secondError);
              localStorage.clear();
              showMessage("info", "저장 공간 부족으로 로컬 백업을 정리했습니다.");
            }
          }
        }
      }

      function loadLocalBackup() {
        try {
          const backup = localStorage.getItem("erNoticesBackup");
          if (backup) {
            const backupData = JSON.parse(backup);
            notices = backupData.notices || [];
            displayNotices();

            const backupAge = new Date() - new Date(backupData.timestamp);
            const hoursAgo = Math.floor(backupAge / (1000 * 60 * 60));

            showMessage("error", `오프라인 모드: ${notices.length}개 백업 데이터 사용 중 (${hoursAgo}시간 전 백업)`);
          } else {
            displayOfflineMessage();
          }
        } catch (error) {
          console.error("백업 로드 오류:", error);
          displayOfflineMessage();
        }
      }

      function displayOfflineMessage() {
        document.getElementById("noticesList").innerHTML = `
          <div class="empty-state">
            <i class="fas fa-wifi-slash"></i>
            <h5>연결 실패</h5>
            <p>Google Apps Script 연결에 문제가 있습니다.</p>
            <p><strong>해결 방법:</strong></p>
            <ul style="text-align: left; display: inline-block;">
              <li>📊 Google Apps Script URL과 권한을 확인해보세요</li>
              <li>🌐 인터넷 연결 상태를 확인해보세요</li>
            </ul>
          </div>
        `;
      }

      // 페이지 언로드 시 정리
      window.addEventListener("beforeunload", function () {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
        }
      });
    </script>
  </body>
</html>