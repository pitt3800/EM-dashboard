<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‘ê¸‰ì‹¤ ê²Œì‹œíŒ ì‹œìŠ¤í…œ</title>

    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- ì•„ì´ì½˜ -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- êµ¬ê¸€ í°íŠ¸ -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #007aff;
        --primary-light: #5ac8fa;
        --primary-dark: #0051d5;
        --secondary: #f2f2f7;
        --success: #34c759;
        --warning: #ff9500;
        --danger: #ff3b30;
        --info: #007aff;
        --dark: #1c1c1e;
        --light: #ffffff;
        --gray-100: #f5f5f7;
        --gray-200: #e5e5ea;
        --gray-300: #d1d1d6;
        --gray-400: #8e8e93;
        --gray-500: #636366;
        --gray-600: #48484a;
        --gray-700: #3a3a3c;
        --gray-800: #2c2c2e;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.08);
        --border-radius: 20px;
        --border-radius-sm: 12px;
        --border-radius-xs: 8px;
      }

      body {
        background: linear-gradient(
          135deg,
          #f5f5f7 0%,
          #fafafa 25%,
          #ffffff 50%,
          #f2f2f7 75%,
          #e5e5ea 100%
        );
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          "Helvetica Neue", "Inter", sans-serif;
        color: var(--dark);
        line-height: 1.47;
        min-height: 100vh;
        font-weight: 400;
      }

      .er-header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.04);
        color: var(--dark);
        padding: 4rem 0;
        margin-bottom: 2.5rem;
        position: relative;
        overflow: hidden;
      }

      .er-header h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-light) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
      }

      .status-online {
        background: var(--success);
        color: white;
      }
      .status-offline {
        background: var(--danger);
        color: white;
      }
      .status-loading {
        background: var(--warning);
        color: white;
      }

      .er-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: saturate(180%) blur(20px);
        border: 0.5px solid rgba(0, 0, 0, 0.04);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .er-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .er-card-header {
        background: rgba(255, 255, 255, 0.9);
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.04);
        padding: 1.5rem 2rem;
        font-weight: 600;
        font-size: 1.125rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notice-item {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
      }

      .notice-item:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      /* ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­ í•œ ì¤„ ìŠ¤íƒ€ì¼ */
      .notice-item-simple {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.9rem;
        justify-content: space-between;
      }

      .notice-item-simple:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .notice-content-simple {
        flex: 1;
        color: var(--dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 1rem;
      }

      .notice-actions-simple {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-shrink: 0;
      }

      .notice-date-simple {
        color: var(--gray-500);
        font-size: 0.8rem;
        white-space: nowrap;
      }

      .notice-author-simple {
        color: var(--gray-400);
        font-size: 0.75rem;
        white-space: nowrap;
      }

      .notice-department-simple {
        color: var(--primary);
        font-weight: 600;
        font-size: 0.85rem;
        min-width: 50px;
        text-align: center;
        flex-shrink: 0;
      }

      .notice-department {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-light) 100%
        );
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 1rem;
      }

      .notice-content {
        flex: 1;
        color: var(--dark);
        line-height: 1.4;
        font-size: 0.9rem;
      }

      .notice-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
      }

      .notice-date {
        color: var(--gray-500);
        font-size: 0.7rem;
        white-space: nowrap;
      }

      .er-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--border-radius-xs);
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        text-decoration: none;
      }

      .er-btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .er-btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        color: white;
      }

      .er-btn-success {
        background: var(--success);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .er-btn-success:hover {
        background: #30d158;
        transform: translateY(-1px);
        color: white;
      }

      .er-btn-outline {
        background: rgba(0, 122, 255, 0.08);
        border: 1px solid rgba(0, 122, 255, 0.15);
        color: var(--primary);
      }

      .er-btn-outline:hover {
        background: rgba(0, 122, 255, 0.12);
        color: var(--primary-dark);
      }

      .er-btn-outline.active {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .btn-group .er-btn:first-child {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
      }

      .btn-group .er-btn:not(:first-child):not(:last-child) {
        border-radius: 0;
        border-left: none;
      }

      .btn-group .er-btn:last-child {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-left: none;
      }

      .er-btn-danger-small {
        background: transparent;
        color: var(--danger);
        border: none;
        padding: 0.3rem;
        font-size: 0.8rem;
        border-radius: 4px;
        opacity: 0.7;
      }

      .er-btn-danger-small:hover {
        background: var(--danger);
        color: white;
        opacity: 1;
      }

      .er-form-control {
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        width: 100%;
        margin-bottom: 1rem;
      }

      .er-form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        outline: none;
        background: rgba(255, 255, 255, 1);
      }

      .er-form-label {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.9rem;
      }

      .er-alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: none;
        box-shadow: var(--shadow-md);
      }

      .er-alert-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border-left: 4px solid var(--success);
      }

      .er-alert-error {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        border-left: 4px solid var(--danger);
      }

      .er-alert-info {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        border-left: 4px solid var(--info);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--gray-600);
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      @media (max-width: 768px) {
        .er-header h1 {
          font-size: 2rem;
        }
        .connection-status {
          position: static;
          margin-bottom: 1rem;
          text-align: center;
        }
        .notice-item {
          flex-direction: column;
          gap: 1rem;
        }
        .notice-actions {
          align-items: flex-start;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ ê·¸ë£¹ ì„¸ë¡œ ë°°ì¹˜ */
        .er-card-header > div {
          flex-direction: column;
          gap: 0.5rem;
          align-items: stretch;
        }

        .btn-group {
          width: 100%;
        }

        .btn-group .er-btn {
          flex: 1;
          justify-content: center;
        }

        /* ê³¼ë³„ í•„í„° ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
        #departmentFilter .d-flex {
          justify-content: flex-start !important;
        }

        #departmentFilter .er-btn {
          font-size: 0.8rem;
          padding: 0.4rem 0.8rem;
        }

        /* ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­ í•œ ì¤„ ìŠ¤íƒ€ì¼ ëª¨ë°”ì¼ ìµœì í™” */
        .notice-item-simple {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .notice-content-simple {
          margin-right: 0;
          order: 2;
        }

        .notice-actions-simple {
          order: 3;
          align-self: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    <div id="connectionStatus" class="connection-status status-loading">
      <i class="fas fa-circle"></i> ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...
    </div>

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="er-header">
      <div class="container">
        <div class="row">
          <div class="col-12 text-center">
            <h1><i class="fas fa-hospital"></i> ì‘ê¸‰ì‹¤ ê²Œì‹œíŒ</h1>
            <p class="lead">Emergency Department Notice Board System</p>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­ -->
      <div class="er-card">
        <div class="er-card-header">
          <span><i class="fas fa-list-alt"></i> ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­</span>
          <div>
            <div class="btn-group" role="group">
              <button
                class="er-btn er-btn-success"
                onclick="refreshNotices()"
                id="refreshBtn"
              >
                <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="showAllNotices()"
                id="allNoticesBtn"
              >
                <i class="fas fa-list"></i> ì „ì²´ ê³µì§€ì‚¬í•­
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="showHistoryNotices()"
                id="historyBtn"
              >
                <i class="fas fa-history"></i> History
              </button>
            </div>

            <!-- ë°±ì—…/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
            <div class="btn-group ms-2" role="group">
              <button
                class="er-btn er-btn-outline"
                onclick="backupNotices()"
                id="backupBtn"
                title="ê³µì§€ì‚¬í•­ì„ JSON íŒŒì¼ë¡œ ë°±ì—…"
              >
                <i class="fas fa-download"></i> ë°±ì—…
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="triggerFileInput()"
                id="restoreBtn"
                title="ë°±ì—… íŒŒì¼ì—ì„œ ê³µì§€ì‚¬í•­ ë³µì›"
              >
                <i class="fas fa-upload"></i> ë¶ˆëŸ¬ì˜¤ê¸°
              </button>
            </div>

            <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
            <input
              type="file"
              id="fileInput"
              accept=".json"
              style="display: none"
              onchange="restoreNotices(event)"
            />
          </div>
        </div>
        <div class="card-body p-4">
          <!-- ê³¼ë³„ ì •ë ¬ ë²„íŠ¼ -->
          <div id="departmentFilter" class="mb-3" style="display: none">
            <div class="d-flex flex-wrap gap-2 justify-content-center">
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('all')"
                id="filter-all"
              >
                <i class="fas fa-list"></i> ì „ì²´
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('GI')"
                id="filter-GI"
              >
                <i class="fas fa-stomach"></i> GI
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('CV')"
                id="filter-CV"
              >
                <i class="fas fa-heartbeat"></i> CV
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('Biliary')"
                id="filter-Biliary"
              >
                <i class="fas fa-liver"></i> Biliary
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('DR')"
                id="filter-DR"
              >
                <i class="fas fa-x-ray"></i> DR
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('NS')"
                id="filter-NS"
              >
                <i class="fas fa-brain"></i> NS
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('GS')"
                id="filter-GS"
              >
                <i class="fas fa-cut"></i> GS
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('PLM')"
                id="filter-PLM"
              >
                <i class="fas fa-lungs"></i> PLM
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('OS')"
                id="filter-OS"
              >
                <i class="fas fa-bone"></i> OS
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('NPH')"
                id="filter-NPH"
              >
                <i class="fas fa-brain"></i> NPH
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('CS')"
                id="filter-CS"
              >
                <i class="fas fa-cut"></i> CS
              </button>
              <button
                class="er-btn er-btn-outline"
                onclick="filterByDepartment('URO')"
                id="filter-URO"
              >
                <i class="fas fa-kidneys"></i> URO
              </button>
              <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” ê¸°íƒ€ ì§„ë£Œê³¼ ë²„íŠ¼ë“¤ -->
              <div id="customDepartmentButtons"></div>
            </div>
          </div>

          <div id="noticesList">
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <h5>ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h5>
              <p>ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ê³µì§€ì‚¬í•­ ì…ë ¥ í¼ -->
      <div class="er-card">
        <div class="er-card-header">
          <i class="fas fa-plus-circle"></i> ìƒˆ ê³µì§€ì‚¬í•­ ë“±ë¡
        </div>
        <div class="card-body p-4">
          <!-- ë©”ì‹œì§€ ì˜ì—­ -->
          <div id="successMessage" class="er-alert er-alert-success">
            <i class="fas fa-check-circle"></i>
            <span id="successText">ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
          </div>
          <div id="errorMessage" class="er-alert er-alert-error">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
          </div>
          <div id="infoMessage" class="er-alert er-alert-info">
            <i class="fas fa-info-circle"></i>
            <span id="infoText">ì‹œìŠ¤í…œ ì •ë³´ì…ë‹ˆë‹¤.</span>
          </div>

          <form id="noticeForm">
            <div class="row">
              <div class="col-md-4">
                <label class="er-form-label"
                  >ì§„ë£Œê³¼ <span style="color: var(--danger)">*</span></label
                >
                <select
                  class="er-form-control"
                  id="department"
                  required
                  onchange="handleDepartmentChange()"
                >
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  <option value="GI">GI</option>
                  <option value="CV">CV</option>
                  <option value="Biliary">Biliary</option>
                  <option value="DR">DR</option>
                  <option value="NS">NS</option>
                  <option value="GS">GS</option>
                  <option value="PLM">PLM</option>
                  <option value="OS">OS</option>
                  <option value="NPH">NPH</option>
                  <option value="CS">CS</option>
                  <option value="URO">URO</option>
                  <option value="OTHER">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
                </select>
                <!-- ê¸°íƒ€ ì§„ë£Œê³¼ ì…ë ¥ í•„ë“œ -->
                <input
                  type="text"
                  class="er-form-control"
                  id="customDepartment"
                  placeholder="ì§„ë£Œê³¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: OBGY, ENT ë“±)"
                  style="display: none; margin-top: 0.5rem"
                  maxlength="10"
                />
              </div>
              <div class="col-md-4">
                <label class="er-form-label"
                  >ì‹œì‘ ë‚ ì§œ <span style="color: var(--danger)">*</span></label
                >
                <input
                  type="date"
                  class="er-form-control"
                  id="startDate"
                  required
                />
              </div>
              <div class="col-md-4">
                <label class="er-form-label">ì¢…ë£Œ ë‚ ì§œ (ì„ íƒ)</label>
                <input type="date" class="er-form-control" id="endDate" />
              </div>
            </div>

            <label class="er-form-label"
              >ê³µì§€ ë‚´ìš© <span style="color: var(--danger)">*</span></label
            >
            <textarea
              class="er-form-control"
              id="content"
              placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
              required
              rows="4"
            ></textarea>

            <label class="er-form-label">ì‘ì„±ì</label>
            <input
              type="text"
              class="er-form-control"
              id="author"
              placeholder="ì‘ì„±ìëª… (ì„ íƒ)"
            />

            <div class="d-flex gap-2 justify-content-end">
              <button
                type="button"
                class="er-btn er-btn-outline"
                onclick="clearForm()"
              >
                <i class="fas fa-redo"></i> ì´ˆê¸°í™”
              </button>
              <button
                type="submit"
                class="er-btn er-btn-primary"
                id="submitBtn"
              >
                <i class="fas fa-save"></i> ë“±ë¡
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
      // ==================== ì„¤ì • ====================
      // ğŸ”§ ìˆ˜ì • êµ¬ì—­ - Google Apps Script URL ì—…ë°ì´íŠ¸ë¨
      const GOOGLE_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbz4pyEdWFBffkL_34JymjJSBME844JFy7FOukH-oXgEkJZOJbCjz59CMA_TcZ6RENK_/exec";
      const AUTO_REFRESH_INTERVAL = 30000; // 30ì´ˆ

      let notices = [];
      let isOnline = false;
      let currentViewMode = "today"; // 'today', 'all', 'history'
      let currentFilter = "all"; // í˜„ì¬ ê³¼ë³„ í•„í„°
      let customDepartments = new Set(); // ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ì €ì¥
      let autoRefreshTimer = null;

      // ==================== ì´ˆê¸°í™” ====================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ğŸ¥ ì‘ê¸‰ì‹¤ ê²Œì‹œíŒ ì‹œìŠ¤í…œ ì‹œì‘");
        initializeSystem();
      });

      function initializeSystem() {
        initializeDates();
        setupFormEventListeners();

        // ê¸°ë³¸ ë³´ê¸° ëª¨ë“œ ì„¤ì •
        currentViewMode = "today";
        currentFilter = "all";
        updateViewButtons();

        // ì €ì¥ëœ ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
        loadCustomDepartments();

        console.log("ğŸ”— Google Apps Script URL:", GOOGLE_SCRIPT_URL);

        // ğŸš€ ìºì‹± ì‹œìŠ¤í…œ: ì¦‰ì‹œ ë¡œë“œ + ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
        loadCachedDataFirst(); // â† ì´ ë¼ì¸ìœ¼ë¡œ ë³€ê²½

        if (AUTO_REFRESH_INTERVAL > 0) {
          startAutoRefresh();
        }
      }

      // ==================== ìºì‹± ì‹œìŠ¤í…œ (ì‹ ê·œ ì¶”ê°€) ====================

      /**
       * ğŸš€ ìºì‹± ì‹œìŠ¤í…œ: ì¦‰ì‹œ ìºì‹œ ë°ì´í„° ë¡œë“œ + ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
       */
      async function loadCachedDataFirst() {
        console.log("ğŸ“‚ ìºì‹œëœ ë°ì´í„° ìš°ì„  ë¡œë“œ ì‹œë„");

        // 1ë‹¨ê³„: ìºì‹œëœ ë°ì´í„° ì¦‰ì‹œ í‘œì‹œ
        const cacheLoaded = loadFromCache();

        if (cacheLoaded) {
          showConnectionStatus(
            "online",
            `ìºì‹œ ë°ì´í„° ë¡œë“œ - ${notices.length}ê°œ ê³µì§€ì‚¬í•­`
          );
          displayNotices();
          updateCacheIndicator(true); // ìºì‹œ ë°ì´í„° í‘œì‹œ ì¤‘ì„ì„ ì•Œë¦¼
          console.log("âš¡ ìºì‹œ ë°ì´í„° ì¦‰ì‹œ í‘œì‹œ ì™„ë£Œ");
        } else {
          // ìºì‹œê°€ ì—†ìœ¼ë©´ ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
          showConnectionStatus("loading", "ìµœì´ˆ ë°ì´í„° ë¡œë“œ ì¤‘...");
        }

        // 2ë‹¨ê³„: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° í™•ì¸
        setTimeout(() => {
          loadNoticesFromGoogleInBackground(cacheLoaded);
        }, 100); // UI ë¸”ë¡œí‚¹ ë°©ì§€ë¥¼ ìœ„í•œ ì§§ì€ ì§€ì—°
      }

      /**
       * ìºì‹œì—ì„œ ë°ì´í„° ë¡œë“œ
       */
      function loadFromCache() {
        try {
          const cached = localStorage.getItem("erNoticesCache");
          if (!cached) {
            console.log("ğŸ“‚ ìºì‹œ ë°ì´í„° ì—†ìŒ");
            return false;
          }

          const cacheData = JSON.parse(cached);
          const cacheAge = new Date() - new Date(cacheData.timestamp);
          const hoursAgo = Math.floor(cacheAge / (1000 * 60 * 60));

          // ìºì‹œê°€ 24ì‹œê°„ ì´ìƒ ì˜¤ë˜ëœ ê²½ìš° ë¬´ì‹œ (ì„ íƒì )
          if (hoursAgo > 24) {
            console.log(`ğŸ“‚ ìºì‹œ ë°ì´í„°ê°€ ë„ˆë¬´ ì˜¤ë˜ë¨ (${hoursAgo}ì‹œê°„ ì „)`);
            localStorage.removeItem("erNoticesCache");
            return false;
          }

          notices = cacheData.notices || [];

          // ìºì‹œëœ ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ë„ ë³µì›
          if (cacheData.customDepartments) {
            customDepartments = new Set(cacheData.customDepartments);
            updateCustomDepartmentButtons();
          }

          console.log(
            `ğŸ“‚ ìºì‹œ ë¡œë“œ ì„±ê³µ: ${notices.length}ê°œ ê³µì§€ì‚¬í•­ (${hoursAgo}ì‹œê°„ ì „ ë°ì´í„°)`
          );
          return true;
        } catch (error) {
          console.error("ğŸ“‚ ìºì‹œ ë¡œë“œ ì˜¤ë¥˜:", error);
          localStorage.removeItem("erNoticesCache");
          return false;
        }
      }

      /**
       * ìºì‹œì— ë°ì´í„° ì €ì¥
       */
      function saveToCache() {
        try {
          const cacheData = {
            notices: notices,
            customDepartments: [...customDepartments],
            timestamp: new Date().toISOString(),
            version: "1.0",
          };

          localStorage.setItem("erNoticesCache", JSON.stringify(cacheData));
          console.log(`ğŸ’¾ ìºì‹œ ì €ì¥ ì™„ë£Œ: ${notices.length}ê°œ ê³µì§€ì‚¬í•­`);
        } catch (error) {
          console.error("ğŸ’¾ ìºì‹œ ì €ì¥ ì˜¤ë¥˜:", error);

          if (error.name === "QuotaExceededError") {
            // ì €ì¥ ê³µê°„ ë¶€ì¡± ì‹œ ê¸°ì¡´ ìºì‹œ ì‚­ì œ í›„ ì¬ì‹œë„
            localStorage.removeItem("erNoticesCache");
            localStorage.removeItem("erNoticesBackup");
            try {
              const minimalCache = {
                notices: notices.slice(0, 50), // ìµœì‹  50ê°œë§Œ ì €ì¥
                customDepartments: [...customDepartments],
                timestamp: new Date().toISOString(),
                version: "1.0",
              };
              localStorage.setItem(
                "erNoticesCache",
                JSON.stringify(minimalCache)
              );
              console.log("ğŸ’¾ ìµœì†Œ ìºì‹œ ì €ì¥ ì™„ë£Œ");
            } catch (secondError) {
              console.error("ğŸ’¾ ìµœì†Œ ìºì‹œë„ ì €ì¥ ì‹¤íŒ¨:", secondError);
            }
          }
        }
      }

      /**
       * ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ
       */
      async function loadNoticesFromGoogleInBackground(hadCache) {
        console.log("ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘");

        try {
          const previousCount = notices.length;
          const previousData = [...notices]; // ì´ì „ ë°ì´í„° ë°±ì—…

          // ê¸°ì¡´ ë¡œë”© í•¨ìˆ˜ í˜¸ì¶œ (UI ìƒíƒœëŠ” ì¡°ìš©íˆ ì—…ë°ì´íŠ¸)
          await loadNoticesFromGoogleSilent();

          // ë°ì´í„° ë³€ê²½ í™•ì¸
          const hasChanges = checkForDataChanges(previousData, notices);

          if (hasChanges) {
            console.log("ğŸ”„ ìƒˆë¡œìš´ ë°ì´í„° ê°ì§€ë¨");
            displayNotices();
            updateCacheIndicator(false); // ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ë¨

            if (hadCache) {
              // ì‚¬ìš©ìì—ê²Œ ì—…ë°ì´íŠ¸ ì•Œë¦¼ (ì¡°ìš©íˆ)
              showQuietUpdateNotification();
            }
          } else {
            console.log("ğŸ”„ ë°ì´í„° ë³€ê²½ ì—†ìŒ");
            updateCacheIndicator(false); // ìµœì‹  ìƒíƒœ í™•ì¸ë¨
          }

          // ìµœì‹  ë°ì´í„°ë¥¼ ìºì‹œì— ì €ì¥
          saveToCache();
        } catch (error) {
          console.error("ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);

          if (hadCache) {
            // ìºì‹œê°€ ìˆì—ˆë‹¤ë©´ ì—°ê²° ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
            showConnectionStatus("offline", `ì˜¤í”„ë¼ì¸ (ìºì‹œ ë°ì´í„° ì‚¬ìš© ì¤‘)`);
          } else {
            // ìºì‹œë„ ì—†ì—ˆë‹¤ë©´ ê¸°ì¡´ ì˜¤ë¥˜ ì²˜ë¦¬
            isOnline = false;
            showConnectionStatus("offline", "ì—°ê²° ì‹¤íŒ¨");
            showMessage("error", `ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
            loadLocalBackup();
          }
        }
      }

      /**
       * ì¡°ìš©í•œ Google Sheets ë°ì´í„° ë¡œë“œ (UI ìƒíƒœ ì—…ë°ì´íŠ¸ ìµœì†Œí™”)
       */
      async function loadNoticesFromGoogleSilent() {
        const formData = new URLSearchParams();
        formData.append("method", "GET");
        formData.append("timestamp", Date.now().toString());

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);

        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: formData,
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          signal: controller.signal,
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(
            `HTTP ì˜¤ë¥˜ ${response.status}: ${response.statusText}`
          );
        }

        const responseText = await response.text();
        const data = JSON.parse(responseText);

        if (data.error) {
          throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${data.error}`);
        }

        notices = data.notices || [];
        isOnline = true;

        // ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ìë™ ê°ì§€
        notices.forEach((notice) => {
          if (
            notice.department &&
            ![
              "GI",
              "CV",
              "Biliary",
              "DR",
              "NS",
              "GS",
              "PLM",
              "OS",
              "NPH",
              "CS",
              "URO",
            ].includes(notice.department)
          ) {
            customDepartments.add(notice.department);
          }
        });

        if (customDepartments.size > 0) {
          saveCustomDepartments();
          updateCustomDepartmentButtons();
        }

        showConnectionStatus("online", `ì—°ê²°ë¨ - ${notices.length}ê°œ ê³µì§€ì‚¬í•­`);
      }

      /**
       * ë°ì´í„° ë³€ê²½ ì—¬ë¶€ í™•ì¸
       */
      function checkForDataChanges(oldData, newData) {
        if (oldData.length !== newData.length) {
          return true;
        }

        // ê°„ë‹¨í•œ í•´ì‹œ ë¹„êµë¡œ ë³€ê²½ ê°ì§€
        const oldHash = JSON.stringify(
          oldData.map((n) => ({
            id: n.id,
            content: n.content,
            startDate: n.startDate,
            endDate: n.endDate,
          }))
        );
        const newHash = JSON.stringify(
          newData.map((n) => ({
            id: n.id,
            content: n.content,
            startDate: n.startDate,
            endDate: n.endDate,
          }))
        );

        return oldHash !== newHash;
      }

      /**
       * ìºì‹œ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
       */
      function updateCacheIndicator(isCache) {
        // ê¸°ì¡´ ì—°ê²° ìƒíƒœ ë©”ì‹œì§€ì— ìºì‹œ ì •ë³´ ì¶”ê°€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„
        // í•„ìš”ì‹œ ë³„ë„ UI ìš”ì†Œ ì¶”ê°€ ê°€ëŠ¥
      }

      /**
       * ì¡°ìš©í•œ ì—…ë°ì´íŠ¸ ì•Œë¦¼
       */
      function showQuietUpdateNotification() {
        // ë„ˆë¬´ ë°©í•´ë˜ì§€ ì•Šê²Œ ì—°ê²° ìƒíƒœë¡œë§Œ í‘œì‹œ
        const currentStatus = document.getElementById("connectionStatus");
        const originalText = currentStatus.textContent;

        currentStatus.textContent = "ğŸ”„ ì—…ë°ì´íŠ¸ë¨";
        currentStatus.style.background = "var(--info)";

        setTimeout(() => {
          showConnectionStatus(
            "online",
            `ì—°ê²°ë¨ - ${notices.length}ê°œ ê³µì§€ì‚¬í•­`
          );
        }, 2000);
      }

      // ==================== êµ¬ê¸€ ì‹œíŠ¸ í†µì‹  (í–¥ìƒëœ ì˜¤ë¥˜ ì²˜ë¦¬) ====================
      async function loadNoticesFromGoogle() {
        showConnectionStatus("loading", "ë°ì´í„° ë¡œë“œ ì¤‘...");

        try {
          console.log("ğŸ”„ Google Sheets ì—°ê²° ì‹œë„");

          const formData = new URLSearchParams();
          formData.append("method", "GET");
          formData.append("timestamp", Date.now().toString());

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(
              `HTTP ì˜¤ë¥˜ ${response.status}: ${response.statusText}`
            );
          }

          let data;
          try {
            const responseText = await response.text();
            console.log(
              "ğŸ“„ ì‘ë‹µ í…ìŠ¤íŠ¸:",
              responseText.substring(0, 200) + "..."
            );
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", parseError);
            throw new Error(
              "ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Google Apps Script ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
            );
          }

          console.log("ğŸ“Š ë°›ì€ ë°ì´í„°:", data);

          if (data.error) {
            if (data.error.includes("openById")) {
              throw new Error(
                "Google Sheets ì ‘ê·¼ ê¶Œí•œ ë˜ëŠ” ì‹œíŠ¸ IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
              );
            }
            throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${data.error}`);
          }

          notices = data.notices || [];
          isOnline = true;
          showConnectionStatus(
            "online",
            `ì—°ê²°ë¨ - ${notices.length}ê°œ ê³µì§€ì‚¬í•­`
          );

          // ê³µì§€ì‚¬í•­ì—ì„œ ì‚¬ìš©ëœ ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ìë™ ê°ì§€ ë° ì¶”ê°€
          notices.forEach((notice) => {
            if (
              notice.department &&
              ![
                "GI",
                "CV",
                "Biliary",
                "DR",
                "NS",
                "GS",
                "PLM",
                "OS",
                "NPH",
                "CS",
                "URO",
              ].includes(notice.department)
            ) {
              customDepartments.add(notice.department);
            }
          });

          if (customDepartments.size > 0) {
            saveCustomDepartments();
            updateCustomDepartmentButtons();
          }

          displayNotices();
          console.log(`âœ… ${notices.length}ê°œ ê³µì§€ì‚¬í•­ ë¡œë“œ ì™„ë£Œ`);
        } catch (error) {
          console.error("âŒ ì—°ê²° ì˜¤ë¥˜:", error);
          isOnline = false;

          let errorMessage = "ì—°ê²° ì‹¤íŒ¨";
          if (error.name === "AbortError") {
            errorMessage = "ì—°ê²° ì‹œê°„ ì´ˆê³¼";
          } else if (error.message.includes("openById")) {
            errorMessage = "ì‹œíŠ¸ ê¶Œí•œ ì˜¤ë¥˜";
          } else if (error.message.includes("Failed to fetch")) {
            errorMessage = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜";
          }

          showConnectionStatus("offline", errorMessage);
          showMessage(
            "error",
            `ì—°ê²° ì‹¤íŒ¨: ${error.message}. Google Apps Script ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`
          );
          loadLocalBackup();
        }
      }

      async function addNoticeToGoogle(noticeData) {
        try {
          showConnectionStatus("loading", "ì €ì¥ ì¤‘...");

          const formData = new URLSearchParams();
          formData.append("method", "POST");
          formData.append("department", noticeData.department);
          formData.append("startDate", noticeData.startDate);
          formData.append("endDate", noticeData.endDate || "");
          formData.append("content", noticeData.content);
          formData.append("author", noticeData.author || "");

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(
              `HTTP ì˜¤ë¥˜ ${response.status}: ${response.statusText}`
            );
          }

          let result;
          try {
            const responseText = await response.text();
            result = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error("ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          if (result.error) {
            if (result.error.includes("openById")) {
              throw new Error("Google Sheets ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
            throw new Error(result.error);
          }

          showMessage("success", "ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");

          setTimeout(() => {
            loadNoticesFromGoogle();
          }, 1000);

          clearForm();
          return true;
        } catch (error) {
          console.error("âŒ ì €ì¥ ì˜¤ë¥˜:", error);
          showMessage("error", `ì €ì¥ ì‹¤íŒ¨: ${error.message}`);

          if (
            error.message.includes("Failed to fetch") ||
            error.message.includes("ì‹œê°„ ì´ˆê³¼")
          ) {
            showMessage("info", "ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ì¸í•´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }

          return false;
        }
      }

      async function deleteNoticeFromGoogle(id) {
        try {
          const formData = new URLSearchParams();
          formData.append("method", "DELETE");
          formData.append("id", id);

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          showMessage("success", "ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadNoticesFromGoogle();
          return true;
        } catch (error) {
          console.error("âŒ ì‚­ì œ ì˜¤ë¥˜:", error);
          showMessage("error", "ì‚­ì œ ì‹¤íŒ¨: " + error.message);
          return false;
        }
      }

      // ==================== ë³´ê¸° ëª¨ë“œ ê´€ë¦¬ ====================
      function showAllNotices() {
        currentViewMode = "all";
        updateViewButtons();
        displayNotices();
        console.log("ğŸ“‹ ì „ì²´ ê³µì§€ì‚¬í•­ ë³´ê¸° ëª¨ë“œ");
      }

      function showHistoryNotices() {
        currentViewMode = "history";
        updateViewButtons();
        displayNotices();
        console.log("ğŸ“œ íˆìŠ¤í† ë¦¬ ë³´ê¸° ëª¨ë“œ");
      }

      function showTodayNotices() {
        currentViewMode = "today";
        updateViewButtons();
        displayNotices();
        console.log("ğŸ“… ì˜¤ëŠ˜ ê³µì§€ì‚¬í•­ ë³´ê¸° ëª¨ë“œ");
      }

      function updateViewButtons() {
        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì´ˆê¸°í™”
        document.getElementById("refreshBtn").classList.remove("active");
        document.getElementById("allNoticesBtn").classList.remove("active");
        document.getElementById("historyBtn").classList.remove("active");

        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë²„íŠ¼ í™œì„±í™”
        if (currentViewMode === "today") {
          document.getElementById("refreshBtn").classList.add("active");
        } else if (currentViewMode === "all") {
          document.getElementById("allNoticesBtn").classList.add("active");
        } else if (currentViewMode === "history") {
          document.getElementById("historyBtn").classList.add("active");
        }

        // ê³¼ë³„ í•„í„° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        const filterDiv = document.getElementById("departmentFilter");
        if (currentViewMode !== "today") {
          filterDiv.style.display = "block";
        } else {
          filterDiv.style.display = "none";
        }

        // í—¤ë” ì œëª© ì—…ë°ì´íŠ¸
        updateHeaderTitle();
      }

      function updateHeaderTitle() {
        const headerSpan = document.querySelector(".er-card-header span");
        if (currentViewMode === "today") {
          headerSpan.innerHTML =
            '<i class="fas fa-list-alt"></i> ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­';
        } else if (currentViewMode === "all") {
          headerSpan.innerHTML = '<i class="fas fa-list"></i> ì „ì²´ ê³µì§€ì‚¬í•­';
        } else if (currentViewMode === "history") {
          headerSpan.innerHTML = '<i class="fas fa-history"></i> íˆìŠ¤í† ë¦¬';
        }
      }

      // ==================== ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ê´€ë¦¬ ====================

      /**
       * ì§„ë£Œê³¼ ì„ íƒ ë³€ê²½ ì²˜ë¦¬
       */
      function handleDepartmentChange() {
        const departmentSelect = document.getElementById("department");
        const customDepartmentInput =
          document.getElementById("customDepartment");

        if (departmentSelect.value === "OTHER") {
          customDepartmentInput.style.display = "block";
          customDepartmentInput.required = true;
          customDepartmentInput.focus();
        } else {
          customDepartmentInput.style.display = "none";
          customDepartmentInput.required = false;
          customDepartmentInput.value = "";
        }
      }

      /**
       * ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
       */
      function loadCustomDepartments() {
        try {
          const saved = localStorage.getItem("customDepartments");
          if (saved) {
            customDepartments = new Set(JSON.parse(saved));
            updateCustomDepartmentButtons();
            console.log(
              `ğŸ“‹ ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ë¡œë“œ: ${customDepartments.size}ê°œ`
            );
          }
        } catch (error) {
          console.error("ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ë¡œë“œ ì˜¤ë¥˜:", error);
          customDepartments = new Set();
        }
      }

      /**
       * ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
       */
      function saveCustomDepartments() {
        try {
          localStorage.setItem(
            "customDepartments",
            JSON.stringify([...customDepartments])
          );
          console.log(
            `ğŸ’¾ ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ì €ì¥: ${customDepartments.size}ê°œ`
          );
        } catch (error) {
          console.error("ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ì €ì¥ ì˜¤ë¥˜:", error);
        }
      }

      /**
       * ìƒˆë¡œìš´ ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ì¶”ê°€
       */
      function addCustomDepartment(departmentName) {
        if (!departmentName || departmentName.trim() === "") {
          return false;
        }

        const cleanName = departmentName.trim().toUpperCase();

        // ê¸°ì¡´ í‘œì¤€ ì§„ë£Œê³¼ì™€ ì¤‘ë³µ í™•ì¸
        const standardDepartments = [
          "GI",
          "CV",
          "BILIARY",
          "DR",
          "NS",
          "GS",
          "PLM",
          "OS",
          "NPH",
          "CS",
          "URO",
        ];
        if (standardDepartments.includes(cleanName)) {
          showMessage(
            "info",
            `${cleanName}ëŠ” ì´ë¯¸ í‘œì¤€ ì§„ë£Œê³¼ì— ìˆìŠµë‹ˆë‹¤. ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.`
          );
          return false;
        }

        // ê¸¸ì´ ì œí•œ (10ì)
        if (cleanName.length > 10) {
          showMessage("error", "ì§„ë£Œê³¼ëª…ì€ 10ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return false;
        }

        // íŠ¹ìˆ˜ë¬¸ì ì œí•œ (ì˜ë¬¸, ìˆ«ìë§Œ í—ˆìš©)
        if (!/^[A-Z0-9]+$/.test(cleanName)) {
          showMessage(
            "error",
            "ì§„ë£Œê³¼ëª…ì€ ì˜ë¬¸ ëŒ€ë¬¸ìì™€ ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."
          );
          return false;
        }

        customDepartments.add(cleanName);
        saveCustomDepartments();
        updateCustomDepartmentButtons();

        showMessage("success", `ìƒˆ ì§„ë£Œê³¼ '${cleanName}'ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        console.log(`â• ìƒˆ ì§„ë£Œê³¼ ì¶”ê°€: ${cleanName}`);

        return true;
      }

      /**
       * ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ í•„í„° ë²„íŠ¼ ì—…ë°ì´íŠ¸
       */
      function updateCustomDepartmentButtons() {
        const container = document.getElementById("customDepartmentButtons");
        container.innerHTML = "";

        customDepartments.forEach((dept) => {
          const button = document.createElement("button");
          button.className = "er-btn er-btn-outline";
          button.id = `filter-${dept}`;
          button.onclick = () => filterByDepartment(dept);
          button.innerHTML = `<i class="fas fa-hospital"></i> ${dept}`;
          container.appendChild(button);
        });
      }

      function filterByDepartment(department) {
        currentFilter = department;

        // ëª¨ë“  í•„í„° ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll('[id^="filter-"]').forEach((btn) => {
          btn.classList.remove("active");
        });

        // ì„ íƒëœ í•„í„° ë²„íŠ¼ í™œì„±í™”
        document.getElementById(`filter-${department}`).classList.add("active");

        displayNotices();
        console.log(`ğŸ¥ ê³¼ë³„ í•„í„° ì ìš©: ${department}`);
      }

      // ==================== UI í•¨ìˆ˜ë“¤ ====================
      function showConnectionStatus(status, message) {
        const statusDiv = document.getElementById("connectionStatus");
        statusDiv.className = `connection-status status-${status}`;

        const icons = {
          online: "fas fa-check-circle",
          offline: "fas fa-exclamation-circle",
          loading: "fas fa-spinner fa-spin",
        };

        statusDiv.innerHTML = `<i class="${icons[status]}"></i> ${message}`;
      }

      function showMessage(type, message) {
        const successDiv = document.getElementById("successMessage");
        const errorDiv = document.getElementById("errorMessage");
        const infoDiv = document.getElementById("infoMessage");

        successDiv.style.display = "none";
        errorDiv.style.display = "none";
        infoDiv.style.display = "none";

        if (type === "success") {
          document.getElementById("successText").textContent = message;
          successDiv.style.display = "block";
          setTimeout(() => (successDiv.style.display = "none"), 5000);
        } else if (type === "error") {
          document.getElementById("errorText").textContent = message;
          errorDiv.style.display = "block";
          setTimeout(() => (errorDiv.style.display = "none"), 8000);
        } else if (type === "info") {
          document.getElementById("infoText").textContent = message;
          infoDiv.style.display = "block";
          setTimeout(() => (infoDiv.style.display = "none"), 10000);
        }
      }

      function displayNotices() {
        const container = document.getElementById("noticesList");
        let filteredNotices = [];

        // ëª¨ë“œì— ë”°ë¼ ê³µì§€ì‚¬í•­ í•„í„°ë§
        if (currentViewMode === "today") {
          filteredNotices = getTodayNotices();
        } else if (currentViewMode === "all") {
          filteredNotices = getAllNotices();
        } else if (currentViewMode === "history") {
          filteredNotices = getHistoryNotices();
        }

        // ê³¼ë³„ í•„í„° ì ìš©
        if (currentFilter !== "all") {
          filteredNotices = filteredNotices.filter(
            (notice) => notice.department === currentFilter
          );
        }

        if (filteredNotices.length === 0) {
          let emptyMessage = "";
          if (currentViewMode === "today") {
            emptyMessage = "ì˜¤ëŠ˜ í‘œì‹œí•  ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤";
          } else if (currentViewMode === "all") {
            emptyMessage = "ì „ì²´ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤";
          } else if (currentViewMode === "history") {
            emptyMessage = "íˆìŠ¤í† ë¦¬ì— í‘œì‹œí•  ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤";
          }

          if (currentFilter !== "all") {
            emptyMessage += ` (${currentFilter} ê³¼)`;
          }

          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <h5>${emptyMessage}</h5>
              <p>ìƒˆë¡œìš´ ê³µì§€ì‚¬í•­ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</p>
            </div>
          `;
          return;
        }

        let html = "";
        filteredNotices.forEach((notice) => {
          html += createNoticeHTML(notice);
        });

        container.innerHTML = html;
        saveLocalBackup();
      }

      function createNoticeHTML(notice) {
        const startDate = new Date(notice.startDate).toLocaleDateString(
          "ko-KR",
          { month: "short", day: "numeric" }
        );
        const endDateText = notice.endDate
          ? ` ~ ${new Date(notice.endDate).toLocaleDateString("ko-KR", {
              month: "short",
              day: "numeric",
            })}`
          : "";

        // ëª¨ë“  ëª¨ë“œì—ì„œ ê°„ë‹¨í•œ í•œ ì¤„ ìŠ¤íƒ€ì¼ ì‚¬ìš©
        return `
          <div class="notice-item-simple" data-id="${notice.id}">
            <span class="notice-department-simple">${notice.department}</span>
            <span class="notice-content-simple">${notice.content}</span>
            <div class="notice-actions-simple">
              <span class="notice-date-simple">${startDate}${endDateText}</span>
              ${
                notice.author
                  ? `<span class="notice-author-simple">${notice.author}</span>`
                  : ""
              }
              <button class="er-btn-danger-small" onclick="deleteNotice('${
                notice.id
              }')" title="ì‚­ì œ">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }

      function getTodayNotices() {
        const today = new Date().toISOString().split("T")[0];
        return notices
          .filter((notice) => {
            return notice.endDate
              ? today >= notice.startDate && today <= notice.endDate
              : today >= notice.startDate;
          })
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }

      function getAllNotices() {
        const today = new Date().toISOString().split("T")[0];
        return notices
          .filter((notice) => {
            // ì˜¤ëŠ˜ ì´í›„ì— ì‹œì‘í•˜ê±°ë‚˜, ì•„ì§ ëë‚˜ì§€ ì•Šì€ ê³µì§€ì‚¬í•­
            return notice.endDate
              ? today <= notice.endDate // ì¢…ë£Œì¼ì´ ì˜¤ëŠ˜ ì´í›„
              : today <= notice.startDate || today >= notice.startDate; // ì‹œì‘ì¼ì´ ì˜¤ëŠ˜ ì´í›„ì´ê±°ë‚˜ ì´ë¯¸ ì‹œì‘ë¨
          })
          .sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); // ì‹œì‘ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
      }

      function getHistoryNotices() {
        const today = new Date().toISOString().split("T")[0];
        return notices
          .filter((notice) => {
            // ì¢…ë£Œì¼ì´ ìˆê³  ì˜¤ëŠ˜ ì´ì „ì— ëë‚œ ê³µì§€ì‚¬í•­
            return notice.endDate && today > notice.endDate;
          })
          .sort((a, b) => new Date(b.endDate) - new Date(a.endDate)); // ì¢…ë£Œì¼ ì—­ìˆœìœ¼ë¡œ ì •ë ¬
      }

      // ==================== ë°±ì—…/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ ====================

      // ğŸ”§ ìˆ˜ì • ê°€ëŠ¥ êµ¬ì—­ - ë°±ì—… íŒŒì¼ëª… ì„¤ì •
      function generateBackupFileName() {
        const now = new Date();
        const dateStr = now.toISOString().split("T")[0]; // YYYY-MM-DD
        const timeStr = now.toTimeString().split(" ")[0].replace(/:/g, "-"); // HH-MM-SS
        return `ì‘ê¸‰ì‹¤ê³µì§€ì‚¬í•­_ë°±ì—…_${dateStr}_${timeStr}.json`;
      }

      /**
       * ì „ì²´ ê³µì§€ì‚¬í•­ì„ JSON íŒŒì¼ë¡œ ë°±ì—…
       */
      function backupNotices() {
        try {
          if (!notices || notices.length === 0) {
            showMessage(
              "info",
              "ë°±ì—…í•  ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”."
            );
            return;
          }

          // ë°±ì—… ë°ì´í„° êµ¬ì¡°
          const backupData = {
            metadata: {
              version: "1.0",
              exportDate: new Date().toISOString(),
              totalNotices: notices.length,
              exportedBy: "ì‘ê¸‰ì‹¤ ê²Œì‹œíŒ ì‹œìŠ¤í…œ",
              description: "ì‘ê¸‰ì˜í•™ê³¼ ê³µì§€ì‚¬í•­ ì „ì²´ ë°±ì—… íŒŒì¼",
            },
            notices: notices.map((notice) => ({
              id: notice.id,
              department: notice.department,
              startDate: notice.startDate,
              endDate: notice.endDate || "",
              content: notice.content,
              author: notice.author || "",
              createdAt: notice.createdAt || new Date().toISOString(),
            })),
          };

          // JSON ë¬¸ìì—´ ìƒì„±
          const jsonString = JSON.stringify(backupData, null, 2);

          // Blob ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = generateBackupFileName();
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          // ë©”ëª¨ë¦¬ ì •ë¦¬
          URL.revokeObjectURL(url);

          showMessage(
            "success",
            `${notices.length}ê°œ ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤!`
          );
          console.log(`ğŸ“¦ ë°±ì—… ì™„ë£Œ: ${notices.length}ê°œ ê³µì§€ì‚¬í•­`);
        } catch (error) {
          console.error("ë°±ì—… ì˜¤ë¥˜:", error);
          showMessage("error", "ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      }

      /**
       * íŒŒì¼ ì…ë ¥ ì°½ íŠ¸ë¦¬ê±°
       */
      function triggerFileInput() {
        document.getElementById("fileInput").click();
      }

      /**
       * ë°±ì—… íŒŒì¼ì—ì„œ ê³µì§€ì‚¬í•­ ë³µì›
       */
      async function restoreNotices(event) {
        const file = event.target.files[0];

        if (!file) {
          return;
        }

        try {
          // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
          if (!file.name.endsWith(".json")) {
            showMessage("error", "JSON íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }

          if (file.size > 10 * 1024 * 1024) {
            // 10MB ì œí•œ
            showMessage("error", "íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€ 10MB)");
            return;
          }

          showMessage("info", "ë°±ì—… íŒŒì¼ì„ ì½ëŠ” ì¤‘...");

          // íŒŒì¼ ì½ê¸°
          const fileContent = await readFileAsText(file);
          const backupData = JSON.parse(fileContent);

          // ë°±ì—… íŒŒì¼ êµ¬ì¡° ê²€ì¦
          if (!validateBackupFile(backupData)) {
            showMessage(
              "error",
              "ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
            );
            return;
          }

          // ë³µì› í™•ì¸
          const confirmMessage = `ë°±ì—… íŒŒì¼ ì •ë³´:
          
â€¢ ë°±ì—… ì¼ì‹œ: ${new Date(backupData.metadata.exportDate).toLocaleString("ko-KR")}
â€¢ ê³µì§€ì‚¬í•­ ìˆ˜: ${backupData.metadata.totalNotices}ê°œ
â€¢ ë²„ì „: ${backupData.metadata.version}

í˜„ì¬ ${notices.length}ê°œì˜ ê³µì§€ì‚¬í•­ì„ ${
            backupData.notices.length
          }ê°œë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?

âš ï¸ ì£¼ì˜: í˜„ì¬ ë°ì´í„°ëŠ” ë³µì› í›„ ì‚¬ë¼ì§‘ë‹ˆë‹¤!`;

          if (!confirm(confirmMessage)) {
            showMessage("info", "ë³µì›ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
          }

          // Google Sheetsì— ë³µì› (ë°°ì¹˜ ì—…ë¡œë“œ)
          const success = await restoreToGoogleSheets(backupData.notices);

          if (success) {
            notices = backupData.notices;
            displayNotices();
            showMessage(
              "success",
              `${backupData.notices.length}ê°œ ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!`
            );
            console.log(
              `ğŸ“¥ ë³µì› ì™„ë£Œ: ${backupData.notices.length}ê°œ ê³µì§€ì‚¬í•­`
            );
          } else {
            showMessage("error", "Google Sheets ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("ë³µì› ì˜¤ë¥˜:", error);

          if (error instanceof SyntaxError) {
            showMessage(
              "error",
              "ë°±ì—… íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤."
            );
          } else {
            showMessage(
              "error",
              "ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message
            );
          }
        } finally {
          // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
          event.target.value = "";
        }
      }

      /**
       * íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ì½ê¸°
       */
      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) => reject(new Error("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
          reader.readAsText(file, "utf-8");
        });
      }

      /**
       * ë°±ì—… íŒŒì¼ ìœ íš¨ì„± ê²€ì¦
       */
      function validateBackupFile(data) {
        try {
          // í•„ìˆ˜ í•„ë“œ í™•ì¸
          if (!data.metadata || !data.notices) {
            return false;
          }

          if (!Array.isArray(data.notices)) {
            return false;
          }

          // ê³µì§€ì‚¬í•­ ë°ì´í„° êµ¬ì¡° í™•ì¸
          for (const notice of data.notices) {
            if (
              !notice.id ||
              !notice.department ||
              !notice.startDate ||
              !notice.content
            ) {
              console.warn("ìœ íš¨í•˜ì§€ ì•Šì€ ê³µì§€ì‚¬í•­ ë°ì´í„°:", notice);
              return false;
            }
          }

          return true;
        } catch (error) {
          console.error("ë°±ì—… íŒŒì¼ ê²€ì¦ ì˜¤ë¥˜:", error);
          return false;
        }
      }

      /**
       * Google Sheetsì— ë°°ì¹˜ë¡œ ë°ì´í„° ë³µì›
       */
      async function restoreToGoogleSheets(noticesData) {
        try {
          showConnectionStatus("loading", "Google Sheetsì— ë³µì› ì¤‘...");

          const formData = new URLSearchParams();
          formData.append("method", "RESTORE");
          formData.append("notices", JSON.stringify(noticesData));
          formData.append("timestamp", Date.now().toString());

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ì´ˆ íƒ€ì„ì•„ì›ƒ

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(
              `HTTP ì˜¤ë¥˜ ${response.status}: ${response.statusText}`
            );
          }

          let result;
          try {
            const responseText = await response.text();
            result = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error("ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          if (result.error) {
            throw new Error(result.error);
          }

          showConnectionStatus(
            "online",
            `ë³µì› ì™„ë£Œ - ${noticesData.length}ê°œ ê³µì§€ì‚¬í•­`
          );
          return true;
        } catch (error) {
          console.error("Google Sheets ë³µì› ì˜¤ë¥˜:", error);
          showConnectionStatus("offline", "ë³µì› ì‹¤íŒ¨");

          // ë¡œì»¬ì—ë§Œ ë³µì›í•˜ê³  ê²½ê³  í‘œì‹œ
          showMessage(
            "error",
            `Google Sheets ë³µì› ì‹¤íŒ¨: ${error.message}. ë°ì´í„°ëŠ” ë¡œì»¬ì—ë§Œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
          return false;
        }
      }

      // ==================== í¼ ê´€ë¦¬ ====================
      function initializeDates() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("startDate").value = today;
      }

      function setupFormEventListeners() {
        document
          .getElementById("noticeForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await addNotice();
          });
      }

      async function addNotice() {
        const departmentSelect = document.getElementById("department");
        const customDepartmentInput =
          document.getElementById("customDepartment");

        let departmentValue = departmentSelect.value;

        // ê¸°íƒ€ ì§„ë£Œê³¼ ì„ íƒ ì‹œ ì‚¬ìš©ì ì…ë ¥ê°’ ì‚¬ìš©
        if (departmentValue === "OTHER") {
          const customValue = customDepartmentInput.value.trim();
          if (!customValue) {
            showMessage("error", "ì§„ë£Œê³¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            customDepartmentInput.focus();
            return;
          }

          // ì‚¬ìš©ì ì •ì˜ ì§„ë£Œê³¼ ì¶”ê°€
          const added = addCustomDepartment(customValue);
          if (!added) {
            return; // ì¶”ê°€ ì‹¤íŒ¨ ì‹œ ì¢…ë£Œ
          }

          departmentValue = customValue.trim().toUpperCase();
        }

        const formData = {
          department: departmentValue,
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value || "",
          content: document.getElementById("content").value.trim(),
          author: document.getElementById("author").value.trim(),
        };

        if (!formData.department || !formData.startDate || !formData.content) {
          showMessage("error", "í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        console.log("ğŸ“ ìƒˆ ê³µì§€ì‚¬í•­ ë“±ë¡:", formData);
        await addNoticeToGoogle(formData);
      }

      function clearForm() {
        document.getElementById("noticeForm").reset();
        document.getElementById("customDepartment").style.display = "none";
        document.getElementById("customDepartment").required = false;
        initializeDates();
      }

      async function deleteNotice(id) {
        if (confirm("ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          await deleteNoticeFromGoogle(id);
        }
      }

      function refreshNotices() {
        currentViewMode = "today";
        currentFilter = "all";
        updateViewButtons();

        // ğŸš€ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨: ê°•ì œë¡œ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        console.log("ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ - ìºì‹œ ë¬´ì‹œí•˜ê³  ìµœì‹  ë°ì´í„° ë¡œë“œ");
        loadNoticesFromGoogle();
      }

      function startAutoRefresh() {
        autoRefreshTimer = setInterval(() => {
          if (isOnline && currentViewMode === "today") {
            console.log("ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨");
            loadNoticesFromGoogle();
          }
        }, AUTO_REFRESH_INTERVAL);
      }

      function saveLocalBackup() {
        try {
          const backupData = {
            notices: notices.slice(0, 50),
            timestamp: new Date().toISOString(),
          };

          localStorage.removeItem("erNoticesBackup");
          const backupString = JSON.stringify(backupData);

          if (backupString.length > 5000000) {
            console.warn(
              "âš ï¸ ë°±ì—… ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœê·¼ 20ê°œë§Œ ì €ì¥í•©ë‹ˆë‹¤."
            );
            backupData.notices = notices.slice(0, 20);
          }

          localStorage.setItem("erNoticesBackup", JSON.stringify(backupData));
          console.log(
            "ğŸ’¾ ë°±ì—… ì €ì¥ ì™„ë£Œ:",
            backupData.notices.length + "ê°œ ê³µì§€ì‚¬í•­"
          );
        } catch (error) {
          console.error("ë°±ì—… ì €ì¥ ì˜¤ë¥˜:", error);

          if (error.name === "QuotaExceededError") {
            try {
              localStorage.removeItem("erNoticesBackup");
              const minimalBackup = {
                notices: notices.slice(0, 10),
                timestamp: new Date().toISOString(),
              };
              localStorage.setItem(
                "erNoticesBackup",
                JSON.stringify(minimalBackup)
              );
              console.log(
                "ğŸ’¾ ìµœì†Œ ë°±ì—… ì €ì¥ ì™„ë£Œ:",
                minimalBackup.notices.length + "ê°œ"
              );
            } catch (secondError) {
              console.error("ìµœì†Œ ë°±ì—…ë„ ì‹¤íŒ¨:", secondError);
              localStorage.clear();
              showMessage(
                "info",
                "ì €ì¥ ê³µê°„ ë¶€ì¡±ìœ¼ë¡œ ë¡œì»¬ ë°±ì—…ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤."
              );
            }
          }
        }
      }

      function loadLocalBackup() {
        try {
          const backup = localStorage.getItem("erNoticesBackup");
          if (backup) {
            const backupData = JSON.parse(backup);
            notices = backupData.notices || [];
            displayNotices();

            const backupAge = new Date() - new Date(backupData.timestamp);
            const hoursAgo = Math.floor(backupAge / (1000 * 60 * 60));

            showMessage(
              "error",
              `ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ${notices.length}ê°œ ë°±ì—… ë°ì´í„° ì‚¬ìš© ì¤‘ (${hoursAgo}ì‹œê°„ ì „ ë°±ì—…)`
            );
          } else {
            displayOfflineMessage();
          }
        } catch (error) {
          console.error("ë°±ì—… ë¡œë“œ ì˜¤ë¥˜:", error);
          displayOfflineMessage();
        }
      }

      function displayOfflineMessage() {
        document.getElementById("noticesList").innerHTML = `
          <div class="empty-state">
            <i class="fas fa-wifi-slash"></i>
            <h5>ì—°ê²° ì‹¤íŒ¨</h5>
            <p>Google Apps Script ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.</p>
            <p><strong>í•´ê²° ë°©ë²•:</strong></p>
            <ul style="text-align: left; display: inline-block;">
              <li>ğŸ“Š Google Apps Script URLê³¼ ê¶Œí•œì„ í™•ì¸í•´ë³´ì„¸ìš”</li>
              <li>ğŸŒ ì¸í„°ë„· ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ë³´ì„¸ìš”</li>
            </ul>
          </div>
        `;
      }

      // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
      window.addEventListener("beforeunload", function () {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
        }
      });
    </script>
  </body>
</html>
