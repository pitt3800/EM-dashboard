<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- üö´ favicon ÏûêÎèô ÏöîÏ≤≠ ÏôÑÏ†Ñ Ï∞®Îã® -->
    <meta
      name="msapplication-config"
      content="data:application/xml;base64,PHhtbD48L3htbD4="
    />
    <title>ÏùëÍ∏âÏã§ Í≤åÏãúÌåê ÏãúÏä§ÌÖú</title>

    <!-- ==================== favicon Ïò§Î•ò ÏôÑÏ†Ñ Ìï¥Í≤∞ Íµ¨Ïó≠ ÏãúÏûë ==================== -->
    <!-- üîß ÏµúÏÜåÌïúÏùò favicon ÏÑ§Ï†ï - GIF ÌòïÏãù ÏÇ¨Ïö© -->
    <link
      rel="icon"
      type="image/gif"
      href="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="
    />
    <!-- ==================== favicon Ïò§Î•ò ÏôÑÏ†Ñ Ìï¥Í≤∞ Íµ¨Ïó≠ ÎÅù ==================== -->

    <!-- Î∂ÄÌä∏Ïä§Ìä∏Îû© CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- ÏïÑÏù¥ÏΩò -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Íµ¨Í∏Ä Ìè∞Ìä∏ -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #007aff;
        --primary-light: #5ac8fa;
        --primary-dark: #0051d5;
        --secondary: #f2f2f7;
        --success: #34c759;
        --warning: #ff9500;
        --danger: #ff3b30;
        --info: #007aff;
        --dark: #1c1c1e;
        --light: #ffffff;
        --gray-100: #f5f5f7;
        --gray-200: #e5e5ea;
        --gray-300: #d1d1d6;
        --gray-400: #8e8e93;
        --gray-500: #636366;
        --gray-600: #48484a;
        --gray-700: #3a3a3c;
        --gray-800: #2c2c2e;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.08);
        --border-radius: 20px;
        --border-radius-sm: 12px;
        --border-radius-xs: 8px;
      }

      body {
        background: linear-gradient(
          135deg,
          #f5f5f7 0%,
          #fafafa 25%,
          #ffffff 50%,
          #f2f2f7 75%,
          #e5e5ea 100%
        );
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          "Helvetica Neue", "Inter", sans-serif;
        color: var(--dark);
        line-height: 1.47;
        min-height: 100vh;
        font-weight: 400;
      }

      .er-header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.04);
        color: var(--dark);
        padding: 4rem 0;
        margin-bottom: 2.5rem;
        position: relative;
        overflow: hidden;
      }

      .er-header h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-light) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
      }

      .status-online {
        background: var(--success);
        color: white;
      }
      .status-offline {
        background: var(--danger);
        color: white;
      }
      .status-loading {
        background: var(--warning);
        color: white;
      }
      .status-demo {
        background: var(--info);
        color: white;
      }

      .er-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: saturate(180%) blur(20px);
        border: 0.5px solid rgba(0, 0, 0, 0.04);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .er-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .er-card-header {
        background: rgba(255, 255, 255, 0.9);
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.04);
        padding: 1.5rem 2rem;
        font-weight: 600;
        font-size: 1.125rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notice-item {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
      }

      .notice-item:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      .notice-department {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-light) 100%
        );
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 1rem;
      }

      .notice-content {
        flex: 1;
        color: var(--dark);
        line-height: 1.4;
        font-size: 0.9rem;
      }

      .notice-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
      }

      .notice-date {
        color: var(--gray-500);
        font-size: 0.7rem;
        white-space: nowrap;
      }

      .er-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--border-radius-xs);
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        text-decoration: none;
      }

      .er-btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .er-btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        color: white;
      }

      .er-btn-success {
        background: var(--success);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .er-btn-success:hover {
        background: #30d158;
        transform: translateY(-1px);
        color: white;
      }

      .er-btn-outline {
        background: rgba(0, 122, 255, 0.08);
        border: 1px solid rgba(0, 122, 255, 0.15);
        color: var(--primary);
      }

      .er-btn-outline:hover {
        background: rgba(0, 122, 255, 0.12);
        color: var(--primary-dark);
      }

      .er-btn-danger-small {
        background: transparent;
        color: var(--danger);
        border: none;
        padding: 0.3rem;
        font-size: 0.8rem;
        border-radius: 4px;
        opacity: 0.7;
      }

      .er-btn-danger-small:hover {
        background: var(--danger);
        color: white;
        opacity: 1;
      }

      .er-form-control {
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        width: 100%;
        margin-bottom: 1rem;
      }

      .er-form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        outline: none;
        background: rgba(255, 255, 255, 1);
      }

      .er-form-label {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.9rem;
      }

      .er-alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: none;
        box-shadow: var(--shadow-md);
      }

      .er-alert-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border-left: 4px solid var(--success);
      }

      .er-alert-error {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        border-left: 4px solid var(--danger);
      }

      .er-alert-info {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        border-left: 4px solid var(--info);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--gray-600);
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        background: var(--gray-800);
        color: white;
        padding: 1.5rem 2rem;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .modal-body {
        padding: 2rem;
      }

      @media (max-width: 768px) {
        .er-header h1 {
          font-size: 2rem;
        }
        .connection-status {
          position: static;
          margin-bottom: 1rem;
          text-align: center;
        }
        .notice-item {
          flex-direction: column;
          gap: 1rem;
        }
        .notice-actions {
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <!-- Ïó∞Í≤∞ ÏÉÅÌÉú ÌëúÏãú -->
    <div id="connectionStatus" class="connection-status status-loading">
      <i class="fas fa-circle"></i> ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...
    </div>

    <!-- ÌéòÏù¥ÏßÄ Ìó§Îçî -->
    <div class="er-header">
      <div class="container">
        <div class="row">
          <div class="col-12 text-center">
            <h1><i class="fas fa-hospital"></i> ÏùëÍ∏âÏã§ Í≤åÏãúÌåê</h1>
            <p class="lead">Emergency Department Notice Board System</p>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Ïò§ÎäòÏùò Í≥µÏßÄÏÇ¨Ìï≠ -->
      <div class="er-card">
        <div class="er-card-header">
          <span><i class="fas fa-list-alt"></i> Ïò§ÎäòÏùò Í≥µÏßÄÏÇ¨Ìï≠</span>
          <div>
            <button
              class="er-btn er-btn-success"
              onclick="refreshNotices()"
              id="refreshBtn"
            >
              <i class="fas fa-sync-alt"></i> ÏÉàÎ°úÍ≥†Ïπ®
            </button>
            <button class="er-btn er-btn-outline" onclick="enterDemoMode()">
              <i class="fas fa-play"></i> Îç∞Î™® Î™®Îìú
            </button>
          </div>
        </div>
        <div class="card-body p-4">
          <div id="noticesList">
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <h5>Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</h5>
              <p>ÏãúÏä§ÌÖúÏùÑ Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Í≥µÏßÄÏÇ¨Ìï≠ ÏûÖÎ†• Ìèº -->
      <div class="er-card">
        <div class="er-card-header">
          <i class="fas fa-plus-circle"></i> ÏÉà Í≥µÏßÄÏÇ¨Ìï≠ Îì±Î°ù
        </div>
        <div class="card-body p-4">
          <!-- Î©îÏãúÏßÄ ÏòÅÏó≠ -->
          <div id="successMessage" class="er-alert er-alert-success">
            <i class="fas fa-check-circle"></i>
            <span id="successText">Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!</span>
          </div>
          <div id="errorMessage" class="er-alert er-alert-error">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</span>
          </div>
          <div id="infoMessage" class="er-alert er-alert-info">
            <i class="fas fa-info-circle"></i>
            <span id="infoText">ÏãúÏä§ÌÖú Ï†ïÎ≥¥ÏûÖÎãàÎã§.</span>
          </div>

          <form id="noticeForm">
            <div class="row">
              <div class="col-md-4">
                <label class="er-form-label"
                  >ÏßÑÎ£åÍ≥º <span style="color: var(--danger)">*</span></label
                >
                <select class="er-form-control" id="department" required>
                  <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                  <option value="GI">GI</option>
                  <option value="CV">CV</option>
                  <option value="Biliary">Biliary</option>
                  <option value="DR">DR</option>
                  <option value="NS">NS</option>
                  <option value="GS">GS</option>
                  <option value="PLM">PLM</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="er-form-label"
                  >ÏãúÏûë ÎÇ†Ïßú <span style="color: var(--danger)">*</span></label
                >
                <input
                  type="date"
                  class="er-form-control"
                  id="startDate"
                  required
                />
              </div>
              <div class="col-md-4">
                <label class="er-form-label">Ï¢ÖÎ£å ÎÇ†Ïßú (ÏÑ†ÌÉù)</label>
                <input type="date" class="er-form-control" id="endDate" />
              </div>
            </div>

            <label class="er-form-label"
              >Í≥µÏßÄ ÎÇ¥Ïö© <span style="color: var(--danger)">*</span></label
            >
            <textarea
              class="er-form-control"
              id="content"
              placeholder="Í≥µÏßÄÏÇ¨Ìï≠ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
              required
              rows="4"
            ></textarea>

            <label class="er-form-label">ÏûëÏÑ±Ïûê</label>
            <input
              type="text"
              class="er-form-control"
              id="author"
              placeholder="ÏûëÏÑ±ÏûêÎ™Ö (ÏÑ†ÌÉù)"
            />

            <div class="d-flex gap-2 justify-content-end">
              <button
                type="button"
                class="er-btn er-btn-outline"
                onclick="clearForm()"
              >
                <i class="fas fa-redo"></i> Ï¥àÍ∏∞Ìôî
              </button>
              <button
                type="submit"
                class="er-btn er-btn-primary"
                id="submitBtn"
              >
                <i class="fas fa-save"></i> Îì±Î°ù
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
      // ==================== ÏÑ§Ï†ï ====================
      const GOOGLE_SCRIPT_URL =
        const GOOGLE_SCRIPT_URL =
          "https://script.google.com/macros/s/AKfycby_w7b7fAmet30qKHuOYiR13-qPuFmENFFlM6vy2sY3-hRRZgNmjewQ4Ium-gv3Vmo/exec";
      const AUTO_REFRESH_INTERVAL = 30000; // 30Ï¥à

      let notices = [];
      let isOnline = false;
      let isDemoMode = false;
      let autoRefreshTimer = null;

      // ==================== Ï¥àÍ∏∞Ìôî ====================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üè• ÏùëÍ∏âÏã§ Í≤åÏãúÌåê ÏãúÏä§ÌÖú ÏãúÏûë");

        // üö´ favicon Ïò§Î•ò ÏôÑÏ†Ñ Ï∞®Îã® - ÏµúÏ¢Ö Ìï¥Í≤∞Ï±Ö
        preventFaviconError();

        initializeSystem();
      });

      function preventFaviconError() {
        // Î™®Îì† favicon Í¥ÄÎ†® ÏöîÏ≤≠ÏùÑ ÏôÑÏ†ÑÌûà Ï∞®Îã®
        const head = document.getElementsByTagName("head")[0];

        // Í∏∞Ï°¥ favicon ÎßÅÌÅ¨Îì§ Ï†úÍ±∞
        const existingIcons = document.querySelectorAll(
          'link[rel*="icon"], link[rel*="shortcut"]'
        );
        existingIcons.forEach((link) => link.remove());

        // ÏôÑÏ†ÑÌûà Îπà favicon ÏÉùÏÑ± (1x1 Ìà¨Î™Ö ÌîΩÏÖÄ)
        const link = document.createElement("link");
        link.rel = "icon";
        link.type = "image/gif";
        link.href =
          "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";
        head.appendChild(link);

        // shortcut iconÎèÑ Í∞ôÏùÄ Î∞©ÏãùÏúºÎ°ú ÏÑ§Ï†ï
        const shortcut = document.createElement("link");
        shortcut.rel = "shortcut icon";
        shortcut.type = "image/gif";
        shortcut.href =
          "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";
        head.appendChild(shortcut);

        // Î∏åÎùºÏö∞Ï†Ä favicon Ï∫êÏãú Î¨¥Î†•Ìôî
        if (window.location.protocol === "file:") {
          // Î°úÏª¨ ÌååÏùºÏóêÏÑú Ïã§Ìñâ Ïãú Ï∂îÍ∞Ä Î≥¥Ìò∏
          const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (mutation.type === "childList") {
                mutation.addedNodes.forEach(function (node) {
                  if (
                    node.tagName === "LINK" &&
                    (node.rel === "icon" || node.rel === "shortcut icon") &&
                    node.href.includes("favicon.ico")
                  ) {
                    node.remove();
                  }
                });
              }
            });
          });
          observer.observe(head, { childList: true, subtree: true });
        }

        console.log("üö´ Favicon Ïò§Î•ò Î∞©ÏßÄ ÏãúÏä§ÌÖú ÌôúÏÑ±Ìôî");
      }

      function initializeSystem() {
        initializeDates();
        setupFormEventListeners();

        console.log(
          "https://script.google.com/macros/s/AKfycbw0Z6XFOXOFUtE6b9lk-G7JTLEBk5btwQ4uHAzT9eMZjoH7AR2mK9mvGsGdhgoLY3n4/exec:",
          GOOGLE_SCRIPT_URL
        );
        loadNoticesFromGoogle();

        if (AUTO_REFRESH_INTERVAL > 0) {
          startAutoRefresh();
        }
      }

      // ==================== Íµ¨Í∏Ä ÏãúÌä∏ ÌÜµÏã† (Ìñ•ÏÉÅÎêú Ïò§Î•ò Ï≤òÎ¶¨) ====================
      async function loadNoticesFromGoogle() {
        if (isDemoMode) {
          loadDemoData();
          return;
        }

        showConnectionStatus("loading", "Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...");

        try {
          console.log("üîÑ Google Sheets Ïó∞Í≤∞ ÏãúÎèÑ");

          const formData = new URLSearchParams();
          formData.append("method", "GET");
          formData.append("timestamp", Date.now().toString());

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000); // 15Ï¥àÎ°ú Îã®Ï∂ï

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(
              `HTTP Ïò§Î•ò ${response.status}: ${response.statusText}`
            );
          }

          let data;
          try {
            const responseText = await response.text();
            console.log(
              "üìÑ ÏùëÎãµ ÌÖçÏä§Ìä∏:",
              responseText.substring(0, 200) + "..."
            );
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error("JSON ÌååÏã± Ïò§Î•ò:", parseError);
            throw new Error(
              "ÏÑúÎ≤Ñ ÏùëÎãµÏùÑ Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Google Apps Script ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî."
            );
          }

          console.log("üìä Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞:", data);

          if (data.error) {
            if (data.error.includes("openById")) {
              throw new Error(
                "Google Sheets Ï†ëÍ∑º Í∂åÌïú ÎòêÎäî ÏãúÌä∏ IDÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî."
              );
            }
            throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${data.error}`);
          }

          notices = data.notices || [];
          isOnline = true;
          showConnectionStatus(
            "online",
            `Ïó∞Í≤∞Îê® - ${notices.length}Í∞ú Í≥µÏßÄÏÇ¨Ìï≠`
          );
          displayNotices();

          console.log(`‚úÖ ${notices.length}Í∞ú Í≥µÏßÄÏÇ¨Ìï≠ Î°úÎìú ÏôÑÎ£å`);
        } catch (error) {
          console.error("‚ùå Ïó∞Í≤∞ Ïò§Î•ò:", error);
          isOnline = false;

          let errorMessage = "Ïó∞Í≤∞ Ïã§Ìå®";
          if (error.name === "AbortError") {
            errorMessage = "Ïó∞Í≤∞ ÏãúÍ∞Ñ Ï¥àÍ≥º";
          } else if (error.message.includes("openById")) {
            errorMessage = "ÏãúÌä∏ Í∂åÌïú Ïò§Î•ò";
          } else if (error.message.includes("Failed to fetch")) {
            errorMessage = "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò";
          }

          showConnectionStatus("offline", errorMessage);
          showMessage(
            "error",
            `Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}. Îç∞Î™® Î™®ÎìúÎ•º ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò Google Apps Script ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.`
          );
          loadLocalBackup();
        }
      }

      async function addNoticeToGoogle(noticeData) {
        if (isDemoMode) {
          return addNoticeToDemo(noticeData);
        }

        try {
          showConnectionStatus("loading", "Ï†ÄÏû• Ï§ë...");

          const formData = new URLSearchParams();
          formData.append("method", "POST");
          formData.append("department", noticeData.department);
          formData.append("startDate", noticeData.startDate);
          formData.append("endDate", noticeData.endDate || "");
          formData.append("content", noticeData.content);
          formData.append("author", noticeData.author || "");

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(
              `HTTP Ïò§Î•ò ${response.status}: ${response.statusText}`
            );
          }

          let result;
          try {
            const responseText = await response.text();
            result = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error("ÏÑúÎ≤Ñ ÏùëÎãµÏùÑ Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
          }

          if (result.error) {
            if (result.error.includes("openById")) {
              throw new Error("Google Sheets Ï†ëÍ∑º Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
            }
            throw new Error(result.error);
          }

          showMessage("success", "Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!");

          setTimeout(() => {
            loadNoticesFromGoogle();
          }, 1000);

          clearForm();
          return true;
        } catch (error) {
          console.error("‚ùå Ï†ÄÏû• Ïò§Î•ò:", error);
          showMessage("error", `Ï†ÄÏû• Ïã§Ìå®: ${error.message}`);

          // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò Ïãú Îç∞Î™® Î™®Îìú Ï†úÏïà
          if (
            error.message.includes("Failed to fetch") ||
            error.message.includes("ÏãúÍ∞Ñ Ï¥àÍ≥º")
          ) {
            showMessage(
              "info",
              "ÎÑ§Ìä∏ÏõåÌÅ¨ Î¨∏Ï†úÎ°ú Ïù∏Ìï¥ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îç∞Î™® Î™®ÎìúÎ•º ÏÇ¨Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî."
            );
          }

          return false;
        }
      }

      async function deleteNoticeFromGoogle(id) {
        if (isDemoMode) {
          return deleteNoticeFromDemo(id);
        }

        try {
          const formData = new URLSearchParams();
          formData.append("method", "DELETE");
          formData.append("id", id);

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          showMessage("success", "Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
          loadNoticesFromGoogle();
          return true;
        } catch (error) {
          console.error("‚ùå ÏÇ≠Ï†ú Ïò§Î•ò:", error);
          showMessage("error", "ÏÇ≠Ï†ú Ïã§Ìå®: " + error.message);
          return false;
        }
      }

      // ==================== Îç∞Î™® Î™®Îìú ====================
      function enterDemoMode() {
        isDemoMode = true;
        console.log("üé≠ Îç∞Î™® Î™®Îìú ÏãúÏûë");
        showConnectionStatus("demo", "Îç∞Î™® Î™®Îìú");
        loadDemoData();
        showMessage("info", "Îç∞Î™® Î™®ÎìúÎ°ú Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§.");
      }

      function loadDemoData() {
        notices = [
          {
            id: "demo-1",
            department: "GI",
            startDate: new Date().toISOString().split("T")[0],
            endDate: "",
            content: "ÎÇ¥ÏãúÍ≤ΩÏã§ Ïû•ÎπÑ Ï†êÍ≤ÄÏúºÎ°ú Ïù∏Ìïú ÏùºÏãú Ï§ëÎã® ÏïàÎÇ¥",
            author: "ÍπÄÏùòÏÇ¨",
            createdAt: new Date().toISOString(),
          },
          {
            id: "demo-2",
            department: "CV",
            startDate: new Date().toISOString().split("T")[0],
            endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
              .toISOString()
              .split("T")[0],
            content: "Ïã¨Ïû•ÎÇ¥Í≥º ÏùëÍ∏âÌôòÏûê Ï†ëÏàò ÏãúÍ∞Ñ Ïó∞Ïû• (24ÏãúÍ∞Ñ)",
            author: "Ïù¥ÏùòÏÇ¨",
            createdAt: new Date().toISOString(),
          },
          {
            id: "demo-3",
            department: "DR",
            startDate: new Date().toISOString().split("T")[0],
            endDate: "",
            content: "MRI Ïû•ÎπÑ ÏóÖÍ∑∏Î†àÏù¥Îìú ÏôÑÎ£å - Í≤ÄÏÇ¨ ÎåÄÍ∏∞ÏãúÍ∞Ñ Îã®Ï∂ï",
            author: "ÏùëÍ∏âÏã§",
            createdAt: new Date().toISOString(),
          },
        ];

        displayNotices();
        console.log("üé≠ Îç∞Î™® Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å");
      }

      function addNoticeToDemo(noticeData) {
        const newNotice = {
          id: "demo-" + Date.now(),
          department: noticeData.department,
          startDate: noticeData.startDate,
          endDate: noticeData.endDate || "",
          content: noticeData.content,
          author: noticeData.author || "",
          createdAt: new Date().toISOString(),
        };

        notices.push(newNotice);
        displayNotices();
        showMessage("success", "Îç∞Î™® Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!");
        clearForm();
        return true;
      }

      function deleteNoticeFromDemo(id) {
        const index = notices.findIndex((n) => n.id === id);
        if (index !== -1) {
          notices.splice(index, 1);
          displayNotices();
          showMessage("success", "Îç∞Î™® Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
          return true;
        }
        return false;
      }

      // ==================== UI Ìï®ÏàòÎì§ ====================
      function showConnectionStatus(status, message) {
        const statusDiv = document.getElementById("connectionStatus");
        statusDiv.className = `connection-status status-${status}`;

        const icons = {
          online: "fas fa-check-circle",
          offline: "fas fa-exclamation-circle",
          loading: "fas fa-spinner fa-spin",
          demo: "fas fa-play-circle",
        };

        statusDiv.innerHTML = `<i class="${icons[status]}"></i> ${message}`;
      }

      function showMessage(type, message) {
        const successDiv = document.getElementById("successMessage");
        const errorDiv = document.getElementById("errorMessage");
        const infoDiv = document.getElementById("infoMessage");

        successDiv.style.display = "none";
        errorDiv.style.display = "none";
        infoDiv.style.display = "none";

        if (type === "success") {
          document.getElementById("successText").textContent = message;
          successDiv.style.display = "block";
          setTimeout(() => (successDiv.style.display = "none"), 5000);
        } else if (type === "error") {
          document.getElementById("errorText").textContent = message;
          errorDiv.style.display = "block";
          setTimeout(() => (errorDiv.style.display = "none"), 8000);
        } else if (type === "info") {
          document.getElementById("infoText").textContent = message;
          infoDiv.style.display = "block";
          setTimeout(() => (infoDiv.style.display = "none"), 10000);
        }
      }

      function displayNotices() {
        const container = document.getElementById("noticesList");
        const todayNotices = getTodayNotices();

        if (todayNotices.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <h5>Ïò§Îäò ÌëúÏãúÌï† Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§</h5>
              <p>ÏÉàÎ°úÏö¥ Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.</p>
            </div>
          `;
          return;
        }

        let html = "";
        todayNotices.forEach((notice) => {
          html += createNoticeHTML(notice);
        });

        container.innerHTML = html;
        saveLocalBackup();
      }

      function createNoticeHTML(notice) {
        const departmentColors = {
          GI: "#10b981",
          CV: "#ef4444",
          Biliary: "#f59e0b",
          DR: "#6366f1",
          NS: "#8b5cf6",
          GS: "#06b6d4",
          PLM: "#84cc16",
        };

        const departmentIcons = {
          GI: "fas fa-stomach",
          CV: "fas fa-heartbeat",
          Biliary: "fas fa-liver",
          DR: "fas fa-x-ray",
          NS: "fas fa-brain",
          GS: "fas fa-cut",
          PLM: "fas fa-lungs",
        };

        const bgColor = departmentColors[notice.department] || "#4f46e5";
        const icon = departmentIcons[notice.department] || "fas fa-hospital";

        const startDate = new Date(notice.startDate).toLocaleDateString(
          "ko-KR",
          { month: "short", day: "numeric" }
        );
        const endDateText = notice.endDate
          ? ` ~ ${new Date(notice.endDate).toLocaleDateString("ko-KR", {
              month: "short",
              day: "numeric",
            })}`
          : " (Î¨¥Í∏∞Ìïú)";

        return `
          <div class="notice-item" data-id="${notice.id}">
            <div>
              <span class="notice-department" style="background: ${bgColor}">
                <i class="${icon}"></i> ${notice.department}
              </span>
              <div class="notice-content">${notice.content.replace(
                /\n/g,
                "<br>"
              )}</div>
            </div>
            <div class="notice-actions">
              <span class="notice-date">${startDate}${endDateText}</span>
              ${
                notice.author
                  ? `<small style="color: var(--gray-500)">${notice.author}</small>`
                  : ""
              }
              <button class="er-btn-danger-small" onclick="deleteNotice('${
                notice.id
              }')" title="ÏÇ≠Ï†ú">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }

      function getTodayNotices() {
        const today = new Date().toISOString().split("T")[0];
        return notices
          .filter((notice) => {
            return notice.endDate
              ? today >= notice.startDate && today <= notice.endDate
              : today >= notice.startDate;
          })
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }

      // ==================== Ìèº Í¥ÄÎ¶¨ ====================
      function initializeDates() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("startDate").value = today;
      }

      function setupFormEventListeners() {
        document
          .getElementById("noticeForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await addNotice();
          });
      }

      async function addNotice() {
        const formData = {
          department: document.getElementById("department").value,
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value || "",
          content: document.getElementById("content").value.trim(),
          author: document.getElementById("author").value.trim(),
        };

        if (!formData.department || !formData.startDate || !formData.content) {
          showMessage("error", "ÌïÑÏàò Ìï≠Î™©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
          return;
        }

        console.log("üìù ÏÉà Í≥µÏßÄÏÇ¨Ìï≠ Îì±Î°ù:", formData);
        await addNoticeToGoogle(formData);
      }

      function clearForm() {
        document.getElementById("noticeForm").reset();
        initializeDates();
      }

      async function deleteNotice(id) {
        if (confirm("Ïù¥ Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
          await deleteNoticeFromGoogle(id);
        }
      }

      // ==================== Í∏∞ÌÉÄ Ìï®ÏàòÎì§ ====================
      function refreshNotices() {
        if (isDemoMode) {
          showMessage("info", "Îç∞Î™® Î™®ÎìúÏóêÏÑúÎäî ÏÉàÎ°úÍ≥†Ïπ®Ïù¥ ÌïÑÏöîÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
        } else {
          loadNoticesFromGoogle();
        }
      }

      function startAutoRefresh() {
        if (isDemoMode) return;
        autoRefreshTimer = setInterval(() => {
          if (isOnline) {
            console.log("üîÑ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®");
            loadNoticesFromGoogle();
          }
        }, AUTO_REFRESH_INTERVAL);
      }

      function saveLocalBackup() {
        try {
          const backupData = {
            notices: notices.slice(0, 50), // üîß ÏµúÎåÄ 50Í∞úÎßå Ï†ÄÏû•ÌïòÏó¨ Ïö©Îüâ Ï†úÌïú
            timestamp: new Date().toISOString(),
          };

          // Í∏∞Ï°¥ Î∞±ÏóÖ ÏÇ≠Ï†ú ÌõÑ ÏÉàÎ°ú Ï†ÄÏû•
          localStorage.removeItem("erNoticesBackup");

          const backupString = JSON.stringify(backupData);

          // Ïö©Îüâ Ï≤¥ÌÅ¨ (ÎåÄÎûµ 5MB Ï†úÌïú)
          if (backupString.length > 5000000) {
            console.warn(
              "‚ö†Ô∏è Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§. ÏµúÍ∑º 20Í∞úÎßå Ï†ÄÏû•Ìï©ÎãàÎã§."
            );
            backupData.notices = notices.slice(0, 20);
          }

          localStorage.setItem("erNoticesBackup", JSON.stringify(backupData));
          console.log(
            "üíæ Î∞±ÏóÖ Ï†ÄÏû• ÏôÑÎ£å:",
            backupData.notices.length + "Í∞ú Í≥µÏßÄÏÇ¨Ìï≠"
          );
        } catch (error) {
          console.error("Î∞±ÏóÖ Ï†ÄÏû• Ïò§Î•ò:", error);

          // localStorage Ï†ïÎ¶¨ ÏãúÎèÑ
          if (error.name === "QuotaExceededError") {
            try {
              // Í∏∞Ï°¥ Î∞±ÏóÖ ÏÇ≠Ï†ú
              localStorage.removeItem("erNoticesBackup");

              // ÏµúÏÜåÌïúÏùò Î∞±ÏóÖÎßå Ï†ÄÏû• (ÏµúÍ∑º 10Í∞ú)
              const minimalBackup = {
                notices: notices.slice(0, 10),
                timestamp: new Date().toISOString(),
              };
              localStorage.setItem(
                "erNoticesBackup",
                JSON.stringify(minimalBackup)
              );
              console.log(
                "üíæ ÏµúÏÜå Î∞±ÏóÖ Ï†ÄÏû• ÏôÑÎ£å:",
                minimalBackup.notices.length + "Í∞ú"
              );
            } catch (secondError) {
              console.error("ÏµúÏÜå Î∞±ÏóÖÎèÑ Ïã§Ìå®:", secondError);
              // localStorage ÏôÑÏ†Ñ Ï†ïÎ¶¨
              localStorage.clear();
              showMessage(
                "info",
                "Ï†ÄÏû• Í≥µÍ∞Ñ Î∂ÄÏ°±ÏúºÎ°ú Î°úÏª¨ Î∞±ÏóÖÏùÑ Ï†ïÎ¶¨ÌñàÏäµÎãàÎã§."
              );
            }
          }
        }
      }

      function loadLocalBackup() {
        try {
          const backup = localStorage.getItem("erNoticesBackup");
          if (backup) {
            const backupData = JSON.parse(backup);
            notices = backupData.notices || [];
            displayNotices();

            const backupAge = new Date() - new Date(backupData.timestamp);
            const hoursAgo = Math.floor(backupAge / (1000 * 60 * 60));

            showMessage(
              "error",
              `Ïò§ÌîÑÎùºÏù∏ Î™®Îìú: ${notices.length}Í∞ú Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© Ï§ë (${hoursAgo}ÏãúÍ∞Ñ Ï†Ñ Î∞±ÏóÖ)`
            );
          } else {
            displayOfflineMessage();
          }
        } catch (error) {
          console.error("Î∞±ÏóÖ Î°úÎìú Ïò§Î•ò:", error);
          displayOfflineMessage();
        }
      }

      function displayOfflineMessage() {
        document.getElementById("noticesList").innerHTML = `
          <div class="empty-state">
            <i class="fas fa-wifi-slash"></i>
            <h5>Ïó∞Í≤∞ Ïã§Ìå®</h5>
            <p>Google Apps Script Ïó∞Í≤∞Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§.</p>
            <p><strong>Ìï¥Í≤∞ Î∞©Î≤ï:</strong></p>
            <ul style="text-align: left; display: inline-block;">
              <li>üé≠ <strong>Îç∞Î™® Î™®Îìú</strong> Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï¥Î≥¥ÏÑ∏Ïöî</li>
              <li>üìä Google Apps Script URLÍ≥º Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî</li>
              <li>üåê Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî</li>
            </ul>
          </div>
        `;
      }

      // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
      window.addEventListener("beforeunload", function () {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
        }
      });
    </script>
  </body>
</html>
